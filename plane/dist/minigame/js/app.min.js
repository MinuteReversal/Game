/*Fri, 23 Feb 2018 09:36:57 GMT*/
function KeyboardListener(){var t=this;return t.keys={Backspace:!1,Tab:!1,Numpad5Center:!1,NumpadEnter:!1,Enter:!1,ShiftLeft:!1,ShiftRight:!1,ControlLeft:!1,ControlRight:!1,AltLeft:!1,AltRight:!1,Pause:!1,CapsLock:!1,Escape:!1,Space:!1,Numpad9PageUp:!1,PageUp:!1,PageDown:!1,Numpad3PageDown:!1,Numpad1End:!1,End:!1,Home:!1,Numpad7Home:!1,ArrowLeft:!1,Numpad4ArrowLeft:!1,ArrowUp:!1,Numpad8ArrowUp:!1,ArrowRight:!1,Numpad6ArrowRight:!1,ArrowDown:!1,Numpad2ArrowDown:!1,Insert:!1,Numpad0Insert:!1,Delete:!1,NumpadDecimalDelete:!1,Digit0:!1,Digit1:!1,Digit2:!1,Digit3:!1,Digit4:!1,Digit5:!1,Digit6:!1,Digit7:!1,Digit8:!1,Digit9:!1,KeyA:!1,KeyB:!1,KeyC:!1,KeyD:!1,KeyE:!1,KeyF:!1,KeyG:!1,KeyH:!1,KeyI:!1,KeyJ:!1,KeyK:!1,KeyL:!1,KeyM:!1,KeyN:!1,KeyO:!1,KeyP:!1,KeyQ:!1,KeyR:!1,KeyS:!1,KeyT:!1,KeyU:!1,KeyV:!1,KeyW:!1,KeyX:!1,KeyY:!1,KeyZ:!1,OSLeft:!1,ContextMenu:!1,Numpad0:!1,Numpad1:!1,Numpad2:!1,Numpad3:!1,Numpad4:!1,Numpad5:!1,Numpad6:!1,Numpad7:!1,Numpad8:!1,Numpad9:!1,NumpadMultiply:!1,NumpadAdd:!1,NumpadSubtract:!1,NumpadDecimal:!1,NumpadDivide:!1,F1:!1,F2:!1,F3:!1,F4:!1,F5:!1,F6:!1,F7:!1,F8:!1,F9:!1,F10:!1,F11:!1,F12:!1,NumLock:!1,ScrollLock:!1,Semicolon:!1,Equal:!1,Comma:!1,Minus:!1,Period:!1,Slash:!1,Backquote:!1,BracketLeft:!1,Backslash:!1,BracketRight:!1,Quote:!1},window.addEventListener("keydown",function(e){e.preventDefault(),t.setKeyStatus(e,!0)}),window.addEventListener("keyup",function(e){t.setKeyStatus(e,!1)}),t.keys}function MouseListener(){var t=this;return t.mouse={Left:!1,LeftDownPosition:{X:0,Y:0},Middle:!1,MiddleDownPosition:{X:0,Y:0},Right:!1,RightDownPosition:{X:0,Y:0},Wheel:0,X:0,Y:0},window.addEventListener("mousedown",function(e){e.preventDefault(),t.setMouseStatus(e,!0)}),window.addEventListener("mouseup",function(e){e.preventDefault(),t.setMouseStatus(e,!1)}),window.addEventListener("mousemove",function(e){e.preventDefault(),t.mouse.X=e.clientX,t.mouse.Y=e.clientY}),window.addEventListener("mousewheel",function(e){e.preventDefault(),t.mouse.Wheel+=e.wheelDelta}),t.mouse}"function"!=typeof Object.assign&&(Object.assign=function(t){"use strict";if(null==t)throw new TypeError("Cannot convert undefined or null to object");t=Object(t);for(var e=1;e<arguments.length;e++){var o=arguments[e];if(null!=o)for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(t[i]=o[i])}return t}),Array.prototype.forEach||(Array.prototype.forEach=function(t){var e,o;if(null==this)throw new TypeError("this is null or not defined");var i=Object(this),n=i.length>>>0;if("function"!=typeof t)throw new TypeError(t+" is not a function");for(arguments.length>1&&(e=arguments[1]),o=0;n>o;){var a;o in i&&(a=i[o],t.call(e,a,o,i)),o++}});var Sound=function(){var t=this;t.isPause=!1,t.list={},arguments[0]instanceof Array&&t.loadList(arguments[0])};Sound.prototype.loadList=function(t){for(var e,o=this,i=0;e=t[i];i++)e.src.indexOf(".mp3")>-1&&(o.list[e.key]=e.entity)},Sound.prototype.play=function(t,e){var o=this,i=o.list[t];if("undefined"!=typeof i){i.loop=!!e;try{i.currentTime=0}catch(n){}i.play()}},Sound.prototype.playAll=function(){var t=this;for(key in t.list)t.list[key].play()},Sound.prototype.pause=function(){var t=this;t.isPause=!0;for(key in t.list)t.list[key].pause()},Sound.prototype["continue"]=function(){var t=this;t.isPause=!1;for(key in t.list)t.list[key].play()},Sound.prototype.stop=function(){var t=this;for(key in t.list){var e=t.list[key];e.pause(),e.currentTime=0}},Sound.prototype.fixIOSCantPlay=function(){var t=this;t.playAll(),t.stop()},Sound.prototype.arraybufferToBase64=function(t){return URL.createObjectURL(new Blob([new Uint8Array(t)],{type:"audio/mpeg"}))};var IEventObject=function(){};IEventObject.prototype.addEventListener=function(t,e){throw new Error("not implement")},IEventObject.prototype.removeEventListener=function(t,e){throw new Error("not implement")},IEventObject.prototype.dispatchEvent=function(t,e){throw new Error("not implement")};var AEventObject=function(){IEventObject.apply(this,arguments),this.listeners=[]};AEventObject.prototype=Object.create(IEventObject.prototype),AEventObject.prototype.addEventListener=function(t,e){var o=this;o.listeners.push({type:t,listeners:e})},AEventObject.prototype.removeEventListener=function(t,e){var o=this,i=arguments[1],n=[];"function"==typeof arguments[0]&&(i=t);for(var a,s=0;a=o.listeners[s];s++){var r=null;"string"==typeof arguments[0]&&"function"==typeof arguments[1]?r=a:"function"==typeof arguments[0]&&(r=a),r&&n.push(r)}for(var a,s=0;a=n[s];s++)o.listeners.splice(o.listeners.indexOf(a),1)},AEventObject.prototype.dispatchEvent=function(t,e){for(var o,i=this,n=0;o=i.listeners[n];n++)o.type===t&&o.listeners(e)};var Resource=function(){AEventObject.apply(this,arguments),this.list=[],this.isComplete=!1,this._loaded=0,arguments[0]instanceof Object&&Object.assign(this,arguments[0])};Resource.prototype=Object.create(AEventObject.prototype),Resource.prototype.ajax=function(t){var e=new XMLHttpRequest,o=Object.assign({url:"",method:"GET",body:null,onLoad:function(t){},onError:function(t){},onComplete:function(t){}},t);e.addEventListener("load",function(t){o.onLoad(this)}),e.addEventListener("error",function(t){o.onError(this)}),e.addEventListener("complete",function(t){o.onComplete(this)}),e.open(o.method,o.url),e.responseType="arraybuffer",e.send(o.body)},Resource.prototype.httpGet=function(t,e){var o=this;o.ajax({url:t,method:"GET",onLoad:e})},Resource.prototype.httpPost=function(t,e,o){var i=this;i.ajax({url:t,method:"POST",body:e,onLoad:o})},Resource.prototype.httpPut=function(t,e,o){var i=this;i.ajax({url:t,method:"PUT",body:e,fnOnLoad:o})},Resource.prototype.httpDelete=function(t,e){var o=this;o.ajax({url:t,method:"DELETE",fnOnLoad:fnOnLoad})},Resource.prototype.loadAll=function(){for(var t,e=this,o=0;t=e.list[o];o++)e.load(t)},Resource.prototype.load=function(t){var e=this,o=null;if(t instanceof String?o=e.get(t):t instanceof Object&&(o=t),o){if(o.src.indexOf(".png")>-1){var i=new Image;i.addEventListener("load",function(t){e.waitLoad()}),i.src=o.src,o.entity=i}if(o.src.indexOf(".mp3")>-1){var n=new Audio;n.addEventListener("canplay",function(t){}),n.src=o.src,o.entity=n,e.waitLoad()}}},Resource.prototype.waitLoad=function(){var t=this;++t._loaded===t.list.length&&(t.isComplete=!0,t.dispatchEvent("complete",{target:t}))},Resource.prototype.add=function(t,e){var o=this,i=o.get(t);if(!i){var n={key:t,src:e,binary:[],contentType:""};o.list.push(n),o.load(n)}},Resource.prototype.get=function(t){for(var e,o=this,i=0;e=o.list[i];i++)if(e.key===t)return e;return null},Resource.prototype.getBase64=function(t){var e=this,o=e.get(t);return o?e.arrayBufferToBase64(o.binary,o.contentType):null},Resource.prototype.remove=function(t){var e=this;e.list.splice(e.list.indexOf(e.get(t)),1)},Resource.prototype.arrayBufferToBase64=function(t,e){return URL.createObjectURL(new Blob([new Uint8Array(t)],{type:e}))};var DataBus=function(){this.scale=1,this.sound=new Sound,this.resource=new Resource,this.list=[],this.removeList=[]};DataBus.prototype.add=function(t){this.list.push(t)},DataBus.prototype.remove=function(t){this.removeList.push(t)},DataBus.prototype.execRemove=function(t){for(var e,o=0;e=this.removeList[o];o++){var i=this.list.indexOf(e);i>-1&&this.list.splice(i,1)}},DataBus.prototype.broadcast=function(t,e){for(var o,i=0;o=this.list[i];i++)o.dispacthEvent(t,e)};var dataBus=new DataBus,AModel=function(){AEventObject.apply(this,arguments);var t=this;if(t.width=0,t.height=0,t.position={x:0,y:0},t.sWidth=0,t.sHeight=0,t.sPosition={x:0,y:0},t.rotate=0,t.scale=1,t.speed=0,t.image=null,"object"==typeof arguments[0])for(p in arguments[0])t[p]=arguments[0][p]};AModel.prototype=Object.create(AEventObject.prototype),AModel.prototype.getBox=function(){var t=this;return{leftTop:t.position,rightTop:{x:t.position.x+t.width,y:t.position.y},rightBottom:{x:t.position.x+t.width,y:t.position.y+t.height},leftBottom:{x:t.position.x,y:t.position.y+t.height}}},AModel.prototype.inBox=function(t){var e=this;return t.x>=e.position.x&&t.x<=e.position.x+e.width&&t.y>=e.position.y&&t.y<=e.position.y+e.height?!0:!1},AModel.prototype.getCenter=function(){var t=this;return{x:t.position.x+t.width/2,y:t.position.y+t.height/2}},AModel.prototype.onFrame=function(t){var e=this,o=e.getCollision(e);o&&(e.dispatchEvent("collision",{target:o}),o.dispatchEvent("collision",{target:e}))},AModel.prototype.getCollision=function(t){for(var e,o=this,i=0;e=dataBus.list[i];i++)if(!(e instanceof Background)&&e!==t&&o.isEgdeCollision(e,t))return e;return null},AModel.prototype.isEgdeCollision=function(t,e){return t.position.x<e.position.x+e.width&&t.position.x+t.width>e.position.x&&t.position.y<e.position.y+e.height&&t.height+t.position.y>e.position.y?!0:!1};var ABullet=function(){AModel.apply(this,arguments);var t=this;dataBus.sound.play("bullet"),t.addEventListener("frame",function(e){t.onFrame(e)}),t.addEventListener("collision",function(e){t.onCollision(e)})};ABullet.prototype=Object.create(AModel.prototype),ABullet.prototype.onFrame=function(t){var e=this;e.position.y-=e.speed,AModel.prototype.onFrame.apply(this,arguments),e.position.y+e.height<0&&dataBus.remove(e)},ABullet.prototype.onCollision=function(t){var e=this;e.owner!==t.target&&t.target instanceof AEnemy&&dataBus.remove(e)};var Background=function(){AModel.apply(this,arguments);var t=this;t.image=dataBus.resource.get("bg").entity,t.width=640,t.height=1136,t.sWidth=t.width,t.sHeight=t.height,t.name="Background",t.resize(),t.addEventListener("frame",function(e){t.onFrame(e)})};Background.prototype=Object.create(AModel.prototype),Background.prototype.resize=function(){var t=this,e=t.height/t.width;t.width=t.windowWidth,t.height=t.windowWidth*e},Background.prototype.onFrame=function(){var t=this;t.position.y+=.1,t.position.y>=t.windowHeight&&(t.position.y=t.windowHeight-t.height-t.height)};var Face=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("face").entity,e.width=640,e.height=1136,e.sWidth=640,e.sHeight=1136};Face.prototype=Object.create(AModel.prototype);var Dialog=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("common").entity,e.width=200,e.height=200,e.sWidth=200,e.sHeight=200};Dialog.prototype=Object.create(AModel.prototype);var Button=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("common").entity,e.width=79,e.height=20,e.sWidth=83,e.sHeight=21,e.sPosition={x:201,y:0}};Button.prototype=Object.create(AModel.prototype),Button.prototype.onAfterFrame=function(t){var e=this,o=t.target.context,i=e.height/2,n=e.text.length*i;o.save(),o.font=i+"px Arial",o.fillText(e.text,e.position.x+(e.width-n)/2,e.position.y+(e.height+i/2)/2),o.restore()};var Bullet1=function(t){ABullet.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=13*dataBus.scale,e.height=28*dataBus.scale,e.sWidth=13,e.sHeight=28,e.sPosition.x=1027,e.sPosition.y=1107,e.speed=10,e.name="Bullet1"};Bullet1.prototype=Object.create(ABullet.prototype);var Bullet2=function(t){ABullet.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=13*dataBus.scale,e.height=28*dataBus.scale,e.sWidth=13,e.sHeight=28,e.sPosition={x:1007,y:1107},e.speed=10,e.name="Bullet2"};Bullet2.prototype=Object.create(ABullet.prototype);var Plane=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=128*dataBus.scale,e.height=166*dataBus.scale,e.sWidth=128,e.sHeight=166,e.sPosition.x=640,e.bulletType=1,e.speed=3,e.hp=1,e.name="plane",e.bombs=0,e.lastAnimation=Date.now(),e.explodeAnimationTotal=5,e.firedTime=0,e.bombTime=0,e.addEventListener("collision",function(t){t.target instanceof AEnemy?e.hp>0&&(--e.hp,0===e.hp&&(e.sPosition.y=2*e.sHeight)):t.target instanceof DoubleLaser?(dataBus.sound.play("getdoublelaser"),1===e.bulletType?e.bulletType=2:e.bulletType=1,dataBus.remove(t.target)):t.target instanceof Bomb&&e.bombs<9&&(dataBus.sound.play("getbomb"),e.bombs++,dataBus.remove(t.target))})};Plane.prototype=Object.create(AModel.prototype),Plane.prototype.fire=function(){var t=this;if(Date.now()-t.firedTime<200)return[];if(t.firedTime=Date.now(),1===t.bulletType){var e=t.getCenter();e.y=t.position.y;var o=new Bullet1({position:e,owner:t});return o.position.x-=o.width/2,[o]}var i=new Bullet2({position:{x:t.position.x,y:t.position.y+t.height/2},owner:t}),n=new Bullet2({position:{x:t.position.x+t.width,y:t.position.y+t.height/2},owner:t});return i.position.x-=i.width/2,n.position.x-=n.width/2,[i,n]},Plane.prototype.dropBomb=function(){var t=this;Date.now()-t.bombTime<200||0===t.bombs||(t.dispatchEvent("dropBomb",{target:t}),dataBus.sound.play("usebomb"),t.bombs--,t.bombTime=Date.now())},Plane.prototype.onFrame=function(t){var e=this;e.hp>0&&e.normalAnimation(),0===e.hp&&e.explodeAnimation(),AModel.prototype.onFrame.apply(this,arguments)},Plane.prototype.normalAnimation=function(){var t=this;Date.now()-t.lastAnimation>500&&(0===t.sPosition.y?t.sPosition.y=t.sHeight:t.sPosition.y=0,t.lastAnimation=Date.now())},Plane.prototype.explodeAnimation=function(){var t=this;if(Date.now()-t.lastAnimation>100){if(t.sPosition.y===2*t.sHeight&&dataBus.sound.play("gameover"),t.sPosition.y===t.explodeAnimationTotal*t.sHeight)return void t.onExplode();t.sPosition.y+=t.sHeight,t.lastAnimation=Date.now()}},Plane.prototype.onExplode=function(){var t=this;t.dispatchEvent("explode")};var AEnemy=function(){AModel.apply(this,arguments)};AEnemy.prototype=Object.create(AModel.prototype);var Enemy1=function(t){AEnemy.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=63*dataBus.scale,e.height=50*dataBus.scale,e.sWidth=63,e.sHeight=50,e.sPosition.x=768,e.rotate=180,e.speed=3,e.name="Enemy1",e.hp=1,e.explodeAnimationTotal=4,e.lastAnimation=0,e.addEventListener("collision",function(t){t.target instanceof ABullet&&e.hp>0&&--e.hp})};Enemy1.prototype=Object.create(AEnemy.prototype),Enemy1.prototype.onFrame=function(t){var e=this;e.hp>0&&(e.position.y+=e.speed),e.position.y>1136&&dataBus.remove(e),0===e.hp&&e.explodeAnimation(),AEnemy.prototype.onFrame.apply(this,arguments)},Enemy1.prototype.explodeAnimation=function(){var t=this;if(t.sPosition.y===t.sHeight&&dataBus.sound.play("enemy1down"),Date.now()-t.lastAnimation>100){if(t.sPosition.y===t.explodeAnimationTotal*t.sHeight)return void t.onExplode();t.sPosition.y+=t.sHeight,t.lastAnimation=Date.now()}},Enemy1.prototype.onExplode=function(){var t=this;t.dispatchEvent("explode"),dataBus.remove(t)};var Enemy2=function(t){AEnemy.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=90*dataBus.scale,e.height=115*dataBus.scale,e.sWidth=90,e.sHeight=115,e.sPosition.x=834,e.rotate=180,e.speed=3,e.name="Enemy2",e.hp=3,e.explodeAnimationTotal=5,e.lastAnimation=0,e.addEventListener("collision",function(t){t.target instanceof ABullet&&e.hp>0&&--e.hp})};Enemy2.prototype=Object.create(AEnemy.prototype),Enemy2.prototype.onFrame=function(t){var e=this;e.hp>0&&(e.position.y+=e.speed),e.position.y>1136&&dataBus.remove(e),2===e.hp&&e.damageAnimation(),0===e.hp&&e.explodeAnimation(),AEnemy.prototype.onFrame.apply(this,arguments)},Enemy2.prototype.damageAnimation=function(){var t=this;t.sPosition.y=t.sHeight},Enemy2.prototype.explodeAnimation=function(){var t=this;if(t.sPosition.y===2*t.sHeight&&dataBus.sound.play("enemy3down"),Date.now()-t.lastAnimation>100){if(t.sPosition.y===t.explodeAnimationTotal*t.sHeight)return void t.onExplode();t.sPosition.y+=t.sHeight,t.lastAnimation=Date.now()}},Enemy2.prototype.onExplode=function(){var t=this;t.dispatchEvent("explode"),dataBus.remove(t)};var Enemy3=function(t){AEnemy.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=218*dataBus.scale,e.height=330*dataBus.scale,e.sWidth=218,e.sHeight=330,e.sPosition.x=926,e.rotate=180,e.speed=3,e.name="Enemy3",e.hp=5,e.explodeAnimationTotal=6,e.normalAnimationTotal=1,e.lastAnimation=0,dataBus.sound.play("enemy2out"),e.addEventListener("collision",function(t){t.target instanceof ABullet&&e.hp>0&&--e.hp})};Enemy3.prototype=Object.create(AEnemy.prototype),Enemy3.prototype.onFrame=function(t){var e=this;e.hp>0&&(e.position.y+=e.speed),e.position.y>1136&&dataBus.remove(e),e.hp>3?e.normalAnimation():3===e.hp&&e.damageAnimation(),0===e.hp&&e.explodeAnimation(),AEnemy.prototype.onFrame.apply(this,arguments)},Enemy3.prototype.normalAnimation=function(){var t=this;Date.now()-t.lastAnimation>500&&(0===t.sPosition.y?t.sPosition.y=t.sHeight:t.sPosition.y=0,t.lastAnimation=Date.now())},Enemy3.prototype.damageAnimation=function(){var t=this;t.sPosition.y=2*t.sHeight},Enemy3.prototype.explodeAnimation=function(){var t=this;if(926===t.sPosition.x&&(dataBus.sound.play("enemy2down"),t.sPosition={x:926+t.sWidth,y:1}),Date.now()-t.lastAnimation>100){if(t.sPosition.x===926+t.explodeAnimationTotal*t.sWidth)return void t.onExplode();t.sPosition.x+=t.sWidth,t.lastAnimation=Date.now()}},Enemy3.prototype.onExplode=function(){var t=this;t.dispatchEvent("explode"),dataBus.remove(t)};var APowerUp=function(){AModel.apply(this,arguments),this.status="showdown"};APowerUp.prototype=Object.create(AModel.prototype),APowerUp.prototype.playAnimation=function(){"showdown"===this.status||"showup"===this.status?this.showAnimation():this.downAnimation()},APowerUp.prototype.showAnimation=function(){"showdown"===this.status?(this.position.y+=5,this.position.y>=3*this.height&&(this.status="showup")):"showup"===this.status&&(this.position.y-=5,this.position.y+this.height<0&&(this.status="down"))},APowerUp.prototype.downAnimation=function(){this.position.y+=10,this.position.y>1136&&dataBus.remove(this)};var Bomb=function(){APowerUp.apply(this,arguments);var t=this;t.image=dataBus.resource.get("bg").entity,t.width=76*dataBus.scale,t.height=136*dataBus.scale,t.sWidth=76,t.sHeight=136,t.sPosition={x:1124,y:1e3}};Bomb.prototype=Object.create(APowerUp.prototype),Bomb.prototype.onFrame=function(){APowerUp.prototype.playAnimation.apply(this,arguments)};var DoubleLaser=function(){APowerUp.apply(this,arguments);var t=this;t.image=dataBus.resource.get("bg").entity,t.width=73*dataBus.scale,t.height=114*dataBus.scale,t.sWidth=73,t.sHeight=114,t.sPosition={x:1050,y:1021}};DoubleLaser.prototype=Object.create(APowerUp.prototype),DoubleLaser.prototype.onFrame=function(){APowerUp.prototype.playAnimation.apply(this,arguments)};var Level1=function(t){this.enemyTypes=[Enemy1],this.count=0,this.width=t.width,this.height=t.height};Level1.prototype.getRandomArbitrary=function(t,e){return Math.random()*(e-t)+t},Level1.prototype.generate=function(t){var e=this;if(40===++e.count){e.count=0;var o=null,i=parseInt(e.getRandomArbitrary(1,5));if(1===i)o=new Enemy1;else if(2===i)o=new Enemy2;else if(3===i)o=new Enemy3;else if(4===i){var n=parseInt(e.getRandomArbitrary(1,5));if(2===n)o=new DoubleLaser;else{if(4!==n)return null;o=new Bomb}}return o.position.x=e.getRandomArbitrary(0,e.width-o.width),o.position.y=-o.height,e.isEgdeCollision(o)?null:o}return null},Level1.prototype.isEgdeCollision=function(t){for(var e,o=0;e=dataBus.list[o];o++)if(e.isEgdeCollision(e,t)&&e instanceof AEnemy)return!0;return!1};var NumberText=function(){AModel.apply(this,arguments);var t=this;t.image=dataBus.resource.get("number").entity,t.number=0,t.width=24,t.height=30,t.sWidth=40,t.sHeight=50,t.addEventListener("frame",function(e){t.sPosition.x=t.sWidth*t.number})};NumberText.prototype=Object.create(AModel.prototype);var Text=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("common").entity,e.width=0,e.height=0,e.sWidth=1,e.sHeight=1,e.sPosition={x:201,y:201}};Text.prototype=Object.create(AModel.prototype),Text.prototype.onAfterFrame=function(t){var e=this,o=t.target.context;o.save(),o.font=e.fontSize+"px Arial",o.fillText(e.text,e.position.x,e.position.y),o.restore()};var BombButton=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=82*dataBus.scale,e.height=68*dataBus.scale,e.sWidth=82,e.sHeight=68,e.sPosition={x:698,y:1066}};BombButton.prototype=Object.create(AModel.prototype);var Cross=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=51*dataBus.scale,e.height=54*dataBus.scale,e.sWidth=51,e.sHeight=54,e.sPosition={x:840,y:1076}};Cross.prototype=Object.create(AModel.prototype),KeyboardListener.prototype.setKeyStatus=function(t,e){var o=this.keys;8===t.keyCode?o.Backspace=e:9===t.keyCode?o.Tab=e:12===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?o.Numpad5Center=e:13===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?o.NumpadEnter=e:13===t.keyCode?o.Enter=e:16===t.keyCode?o.ShiftLeft=e:16===t.keyCode?o.ShiftRight=e:17===t.keyCode?o.ControlLeft=e:17===t.keyCode?o.ControlRight=e:18===t.keyCode?o.AltLeft=e:18===t.keyCode?o.AltRight=e:19===t.keyCode?o.Pause=e:20===t.keyCode?o.CapsLock=e:27===t.keyCode?o.Escape=e:32===t.keyCode?o.Space=e:33===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?o.Numpad9PageUp=e:33===t.keyCode?o.PageUp=e:34===t.keyCode?o.PageDown=e:34===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?o.Numpad3PageDown=e:35===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?o.Numpad1End=e:35===t.keyCode?o.End=e:36===t.keyCode?o.Home=e:36===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?o.Numpad7Home=e:37===t.keyCode?o.ArrowLeft=e:37===t.keyCode?o.Numpad4ArrowLeft=e:38===t.keyCode?o.ArrowUp=e:38===t.keyCode?o.Numpad8ArrowUp=e:39===t.keyCode?o.ArrowRight=e:39===t.keyCode?o.Numpad6ArrowRight=e:40===t.keyCode?o.ArrowDown=e:40===t.keyCode?o.Numpad2ArrowDown=e:45===t.keyCode?o.Insert=e:45===t.keyCode?o.Numpad0Insert=e:46===t.keyCode?o.Delete=e:46===t.keyCode?o.NumpadDecimalDelete=e:48===t.keyCode?o.Digit0=e:49===t.keyCode?o.Digit1=e:50===t.keyCode?o.Digit2=e:51===t.keyCode?o.Digit3=e:52===t.keyCode?o.Digit4=e:53===t.keyCode?o.Digit5=e:54===t.keyCode?o.Digit6=e:55===t.keyCode?o.Digit7=e:56===t.keyCode?o.Digit8=e:57===t.keyCode?o.Digit9=e:65===t.keyCode?o.KeyA=e:66===t.keyCode?o.KeyB=e:67===t.keyCode?o.KeyC=e:68===t.keyCode?o.KeyD=e:69===t.keyCode?o.KeyE=e:70===t.keyCode?o.KeyF=e:71===t.keyCode?o.KeyG=e:72===t.keyCode?o.KeyH=e:73===t.keyCode?o.KeyI=e:74===t.keyCode?o.KeyJ=e:75===t.keyCode?o.KeyK=e:76===t.keyCode?o.KeyL=e:77===t.keyCode?o.KeyM=e:78===t.keyCode?o.KeyN=e:79===t.keyCode?o.KeyO=e:80===t.keyCode?o.KeyP=e:81===t.keyCode?o.KeyQ=e:82===t.keyCode?o.KeyR=e:83===t.keyCode?o.KeyS=e:84===t.keyCode?o.KeyT=e:85===t.keyCode?o.KeyU=e:86===t.keyCode?o.KeyV=e:87===t.keyCode?o.KeyW=e:88===t.keyCode?o.KeyX=e:89===t.keyCode?o.KeyY=e:90===t.keyCode?o.KeyZ=e:91===t.keyCode?o.OSLeft=e:93===t.keyCode?o.ContextMenu=e:96===t.keyCode?o.Numpad0=e:97===t.keyCode?o.Numpad1=e:98===t.keyCode?o.Numpad2=e:99===t.keyCode?o.Numpad3=e:100===t.keyCode?o.Numpad4=e:101===t.keyCode?o.Numpad5=e:102===t.keyCode?o.Numpad6=e:103===t.keyCode?o.Numpad7=e:104===t.keyCode?o.Numpad8=e:105===t.keyCode?o.Numpad9=e:106===t.keyCode?o.NumpadMultiply=e:107===t.keyCode?o.NumpadAdd=e:109===t.keyCode?o.NumpadSubtract=e:110===t.keyCode?o.NumpadDecimal=e:111===t.keyCode?o.NumpadDivide=e:112===t.keyCode?o.F1=e:113===t.keyCode?o.F2=e:114===t.keyCode?o.F3=e:115===t.keyCode?o.F4=e:116===t.keyCode?o.F5=e:117===t.keyCode?o.F6=e:118===t.keyCode?o.F7=e:119===t.keyCode?o.F8=e:120===t.keyCode?o.F9=e:121===t.keyCode?o.F10=e:122===t.keyCode?o.F11=e:123===t.keyCode?o.F12=e:144===t.keyCode?o.NumLock=e:145===t.keyCode?o.ScrollLock=e:186===t.keyCode?o.Semicolon=e:187===t.keyCode?o.Equal=e:188===t.keyCode?o.Comma=e:189===t.keyCode?o.Minus=e:190===t.keyCode?o.Period=e:191===t.keyCode?o.Slash=e:192===t.keyCode?o.Backquote=e:219===t.keyCode?o.BracketLeft=e:220===t.keyCode?o.Backslash=e:221===t.keyCode?o.BracketRight=e:222===t.keyCode&&(o.Quote=e)},MouseListener.prototype.setMouseStatus=function(t,e){var o=this,i=o.mouse;switch(t.which){case 1:i.Left=e,i.Left?(i.LeftDownPosition.X=t.clientX,i.LeftDownPosition.Y=t.clientY):(i.LeftDownPosition.X=0,i.LeftDownPosition.Y=0);break;case 2:i.Middle=e,i.Middle?(i.MiddleDownPosition.X=t.clientX,i.MiddleDownPosition.Y=t.clientY):(i.MiddleDownPosition.X=0,i.MiddleDownPosition.Y=0);break;case 3:i.Right=e,i.Right?(i.RightDownPosition.X=t.clientX,i.RightDownPosition.Y=t.clientY):(i.RightDownPosition.X=0,i.RightDownPosition.Y=0)}};var TouchListener=function(){var t=this;t.list=[],window.addEventListener("touchstart",function(e){e.preventDefault();for(var o,i=0;o=e.changedTouches[i];i++)null===t.find(o.identifier)&&t.list.push({x:o.pageX,y:o.pageY,identifier:o.identifier})}),window.addEventListener("touchmove",function(e){e.preventDefault();for(var o,i=0;o=e.changedTouches[i];i++){var n=t.find(o.identifier);n&&(n.x=o.pageX,n.y=o.pageY)}}),window.addEventListener("touchend",function(e){e.preventDefault();for(var o,i=0;o=e.changedTouches[i];i++){var n=t.find(o.identifier);if(n){var a=t.list.indexOf(n);t.list.splice(a,1)}}}),window.addEventListener("touchcancel",function(e){e.preventDefault();for(var o,i=0;o=e.changedTouches[i];i++){var n=t.find(o.identifier);if(n){var a=list.indexOf(n);t.list.splice(a,1)}}})};TouchListener.prototype.find=function(t){for(var e,o=this,i=0;e=o.list[i];i++)if(e.identifier===t)return e;return null};var Game=function(t){var e=this;e.isPause=!1,e.isDrawBox=!1,e.showFps=!1,e.keyboard=null,e.mouse=null,e.touch=null,e.sound=dataBus.sound,e.resource=dataBus.resource,e.player1=null,e.player2=null,e.resources=null,e.canvas=t.canvas?t.canvas:e.createCanvas(t.width,t.height),e.context=e.canvas.getContext("2d"),e.map=new Level1({width:t.width,height:t.height}),e.width=t.width,e.height=t.height,e.lastTime=Date.now(),e.frameCount=0,e.fps=0,e.score=0,e.scoreList=[],e.bombList=[],e.timer=null,e.fixSound=!1,dataBus.scale=e.width/1136<.5?.5:e.width/1136,t&&(t.keyboard&&(e.keyboard=t.keyboard),t.mouse&&(e.mouse=t.mouse),t.touch&&(e.touch=t.touch)),e.canvas.addEventListener("click",function(t){e.dispatchClick({x:e.mouse.X,y:e.mouse.Y})}),e.canvas.addEventListener("touchend",function(t){var o=e.touch.list[0];o&&e.dispatchClick({x:o.x,y:o.y})}),e.resource.addEventListener("complete",function(t){dataBus.sound.loadList(dataBus.resource.list),e.touchToStart()}),e.resource.loadAll()};Game.prototype.dispatchClick=function(t){for(var e,o=0;e=dataBus.list[o];o++)t.x>=e.position.x&&t.x<=e.position.x+e.width&&t.y>=e.position.y&&t.y<=e.position.y+e.height&&e.dispatchEvent("click",t)},Game.prototype.touchToStart=function(){var t=this,e=new Face;e.width=t.width,e.height=t.width/640*1136;var o=new Button;o.text="开始游戏",o.width=t.width/4,o.height=.25*t.width/4,o.addEventListener("click",function(){t.fixSound||(dataBus.sound.fixIOSCantPlay(),t.fixSound=!0),t.start()}),o.position.x=(t.width-o.width)/2,o.position.y=t.height-o.height-t.height/20,dataBus.add(e),dataBus.add(o),t.draw()},Game.prototype.gameover=function(){var t=this,e=new Dialog;e.position.x=(t.width-e.width)/2,e.position.y=(t.height-e.height)/2;var o=new Button;o.text="重新开始",o.position.x=e.position.x+(e.width-o.width)/2,o.position.y=e.position.y+e.height-o.height-10,o.addEventListener("click",function(e){t.start()});var i=new Text;i.text="飞机大战得分",i.fontSize=15,i.position.x=e.position.x+(e.width-i.text.length*i.fontSize)/2,i.position.y=e.position.y+23;var n=new Text;n.text=t.score.toString(),n.fontSize=20,n.position.x=e.position.x+(e.width-n.text.length*n.fontSize)/2+5,n.position.y=e.position.y+100,dataBus.add(e),dataBus.add(o),dataBus.add(i),dataBus.add(n)},Game.prototype.start=function(){var t=this;try{dataBus.list=[],t.scoreList=[],t.bombList=[],t.score=0,t.bombs=0,t.addBackground(),t.addScore(),t.addPlayer1(),t.addBombButton(),t.sound.play("bgm",!0),t.timer?t.isPause=!1:t.loop()}catch(e){alert(e.message)}},Game.prototype.createCanvas=function(t,e){var o=document.createElement("canvas");return o.width=t,o.height=e,document.body.appendChild(o),o},Game.prototype.loop=function(){var t=this,e=function(o){t.keyboard.Enter&&(t.isPause=!t.isPause),t.isPause||(t.generateEnermy(o),t.keyboardWatch(o),t.touchWatch(o),t.update(o),t.draw(o)),t.isPause&&!t.sound.isPause&&t.sound.pause(),!t.isPause&&t.sound.isPause&&t.sound["continue"](),t.timer=requestAnimationFrame(e)};t.timer=requestAnimationFrame(e)},Game.prototype.generateEnermy=function(t){var e=this,o=e.map.generate(t);o&&(o.addEventListener("explode",function(t){e.score++}),dataBus.add(o))},Game.prototype.draw=function(){for(var t,e=this,o=Date.now(),i=0;t=dataBus.list[i];i++)if(t.onFrame&&t.onFrame({target:e}),"undefined"!=typeof t.getCenter){var n=t.getCenter();e.context.save(),e.context.translate(n.x,n.y),e.context.rotate(t.rotate*Math.PI/180),e.context.translate(-t.width/2,-t.height/2),e.context.drawImage(t.image,t.sPosition.x,t.sPosition.y,t.sWidth,t.sHeight,0,0,t.width,t.height),e.context.restore(),!e.isDrawBox||t instanceof Background||(e.context.save(),e.context.strokeStyle="red",e.context.strokeRect(t.position.x,t.position.y,t.width,t.height),e.context.fillText(t.position.x+","+t.position.y,t.position.x,t.position.y),e.context.restore()),t.onAfterFrame&&t.onAfterFrame({target:e})}e.drawScore(),e.drawBomb(),e.showFps&&(o-e.lastTime>=1e3&&(e.fps=e.frameCount,e.lastTime=o,e.frameCount=0),++e.frameCount,e.context.save(),e.context.strokeStyle="black",e.context.fillText("FPS:"+e.fps,20,e.height-20),e.context.restore())},Game.prototype.drawScore=function(){var t=this,e=t.score,o=0,i=0;if(t.scoreList.length)for(;e>0;)o=e%10,t.scoreList[i].number=o,e=parseInt(e/10),i++},Game.prototype.drawBomb=function(){var t=this;null!==t.player1&&(t.bombList[2].number=t.player1.bombs)},Game.prototype.addBombButton=function(){var t=this,e=new BombButton({position:{x:0}});e.position.y=t.height-e.height;var o=new Cross({position:{x:e.width}});o.position.y=t.height-o.height;var i=new NumberText;i.position.x=e.width+o.width,i.position.y=t.height-i.height,t.bombList.push(e),t.bombList.push(o),t.bombList.push(i),dataBus.add(e),dataBus.add(o),dataBus.add(i)},Game.prototype.update=function(t){for(var e,o=this,i=0;e=dataBus.list[i];i++)e.dispatchEvent("frame",{target:o,timeStamp:t});dataBus.execRemove()},Game.prototype.addBackground=function(){var t=this,e=new Background({windowWidth:t.width,windowHeight:t.height}),o=new Background({windowWidth:t.width,windowHeight:t.height});o.position.y=-o.height,dataBus.add(e),dataBus.add(o)},Game.prototype.addScore=function(){for(var t=this,e=5;e>=0;e--){var o=new NumberText;o.position.x=e*o.width,t.scoreList.push(o),dataBus.add(o)}},Game.prototype.addPlayer1=function(){var t=this,e=new Plane({scale:t.scale});e.position.x=(t.canvas.width-e.width)/2,e.position.y=t.canvas.height-1.2*e.height,e.addEventListener("explode",function(e){t.gameover(),t.isPause=!0,dataBus.sound.pause()}),e.addEventListener("dropBomb",function(t){for(var e,o=0;e=dataBus.list[o];o++)e instanceof AEnemy&&(e.hp=0,e.explodeAnimation())}),t.player1=e,dataBus.add(t.player1)},Game.prototype.keyboardWatch=function(){var t=this,e=t.keyboard;if(t.player1){var o=t.player1;e.KeyW&&o.position.y>0&&(o.position.y-=o.speed),e.KeyA&&o.position.x>0&&(o.position.x-=o.speed),e.KeyS&&o.position.y+o.height<t.height&&(o.position.y+=o.speed),e.KeyD&&o.position.x+o.width<t.width&&(o.position.x+=o.speed),e.KeyJ&&(dataBus.list=dataBus.list.concat(o.fire())),e.KeyK&&o.dropBomb()}},Game.prototype.touchWatch=function(){var t=this,e=t.player1,o=t.findTouchPoint(e);o&&(e.position.x=o.x-e.width/2,e.position.y=o.y-e.height/2,dataBus.list=dataBus.list.concat(e.fire()));var i=t.findTouchPoint(t.bombList[0]);i&&e.dropBomb()},Game.prototype.findTouchPoint=function(t){for(var e,o=this,i=0;e=o.touch.list[i];i++)if(t.inBox(e))return e;return null};