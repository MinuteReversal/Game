/*Fri, 23 Feb 2018 08:55:57 GMT*/
function KeyboardListener(){var t=this;return t.keys={Backspace:!1,Tab:!1,Numpad5Center:!1,NumpadEnter:!1,Enter:!1,ShiftLeft:!1,ShiftRight:!1,ControlLeft:!1,ControlRight:!1,AltLeft:!1,AltRight:!1,Pause:!1,CapsLock:!1,Escape:!1,Space:!1,Numpad9PageUp:!1,PageUp:!1,PageDown:!1,Numpad3PageDown:!1,Numpad1End:!1,End:!1,Home:!1,Numpad7Home:!1,ArrowLeft:!1,Numpad4ArrowLeft:!1,ArrowUp:!1,Numpad8ArrowUp:!1,ArrowRight:!1,Numpad6ArrowRight:!1,ArrowDown:!1,Numpad2ArrowDown:!1,Insert:!1,Numpad0Insert:!1,Delete:!1,NumpadDecimalDelete:!1,Digit0:!1,Digit1:!1,Digit2:!1,Digit3:!1,Digit4:!1,Digit5:!1,Digit6:!1,Digit7:!1,Digit8:!1,Digit9:!1,KeyA:!1,KeyB:!1,KeyC:!1,KeyD:!1,KeyE:!1,KeyF:!1,KeyG:!1,KeyH:!1,KeyI:!1,KeyJ:!1,KeyK:!1,KeyL:!1,KeyM:!1,KeyN:!1,KeyO:!1,KeyP:!1,KeyQ:!1,KeyR:!1,KeyS:!1,KeyT:!1,KeyU:!1,KeyV:!1,KeyW:!1,KeyX:!1,KeyY:!1,KeyZ:!1,OSLeft:!1,ContextMenu:!1,Numpad0:!1,Numpad1:!1,Numpad2:!1,Numpad3:!1,Numpad4:!1,Numpad5:!1,Numpad6:!1,Numpad7:!1,Numpad8:!1,Numpad9:!1,NumpadMultiply:!1,NumpadAdd:!1,NumpadSubtract:!1,NumpadDecimal:!1,NumpadDivide:!1,F1:!1,F2:!1,F3:!1,F4:!1,F5:!1,F6:!1,F7:!1,F8:!1,F9:!1,F10:!1,F11:!1,F12:!1,NumLock:!1,ScrollLock:!1,Semicolon:!1,Equal:!1,Comma:!1,Minus:!1,Period:!1,Slash:!1,Backquote:!1,BracketLeft:!1,Backslash:!1,BracketRight:!1,Quote:!1},window.addEventListener("keydown",function(e){e.preventDefault(),t.setKeyStatus(e,!0)}),window.addEventListener("keyup",function(e){t.setKeyStatus(e,!1)}),t.keys}function MouseListener(){var t=this;return t.mouse={Left:!1,LeftDownPosition:{X:0,Y:0},Middle:!1,MiddleDownPosition:{X:0,Y:0},Right:!1,RightDownPosition:{X:0,Y:0},Wheel:0,X:0,Y:0},window.addEventListener("mousedown",function(e){e.preventDefault(),t.setMouseStatus(e,!0)}),window.addEventListener("mouseup",function(e){e.preventDefault(),t.setMouseStatus(e,!1)}),window.addEventListener("mousemove",function(e){e.preventDefault(),t.mouse.X=e.clientX,t.mouse.Y=e.clientY}),window.addEventListener("mousewheel",function(e){e.preventDefault(),t.mouse.Wheel+=e.wheelDelta}),t.mouse}"function"!=typeof Object.assign&&(Object.assign=function(t){"use strict";if(null==t)throw new TypeError("Cannot convert undefined or null to object");t=Object(t);for(var e=1;e<arguments.length;e++){var n=arguments[e];if(null!=n)for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t}),Array.prototype.forEach||(Array.prototype.forEach=function(t){var e,n;if(null==this)throw new TypeError("this is null or not defined");var o=Object(this),i=o.length>>>0;if("function"!=typeof t)throw new TypeError(t+" is not a function");for(arguments.length>1&&(e=arguments[1]),n=0;i>n;){var r;n in o&&(r=o[n],t.call(e,r,n,o)),n++}}),Enumerable=function(){var t=function(t){this.GetEnumerator=t};t.Choice=function(){var n=arguments[0]instanceof Array?arguments[0]:arguments;return new t(function(){return new r(e.Blank,function(){return this.Yield(n[Math.floor(Math.random()*n.length)])},e.Blank)})},t.Cycle=function(){var n=arguments[0]instanceof Array?arguments[0]:arguments;return new t(function(){var t=0;return new r(e.Blank,function(){return t>=n.length&&(t=0),this.Yield(n[t++])},e.Blank)})},t.Empty=function(){return new t(function(){return new r(e.Blank,function(){return!1},e.Blank)})},t.From=function(i){if(null==i)return t.Empty();if(i instanceof t)return i;if(typeof i==n.Number||typeof i==n.Boolean)return t.Repeat(i,1);if(typeof i==n.String)return new t(function(){var t=0;return new r(e.Blank,function(){return t<i.length?this.Yield(i.charAt(t++)):!1},e.Blank)});if(typeof i!=n.Function){if(typeof i.length==n.Number)return new c(i);if(!(i instanceof Object)&&o.IsIEnumerable(i))return new t(function(){var t,n=!0;return new r(function(){t=new Enumerator(i)},function(){return n?n=!1:t.moveNext(),t.atEnd()?!1:this.Yield(t.item())},e.Blank)})}return new t(function(){var t=[],n=0;return new r(function(){for(var e in i)i[e]instanceof Function||t.push({Key:e,Value:i[e]})},function(){return n<t.length?this.Yield(t[n++]):!1},e.Blank)})},t.Return=function(e){return t.Repeat(e,1)},t.Matches=function(n,o,i){return null==i&&(i=""),o instanceof RegExp&&(i+=o.ignoreCase?"i":"",i+=o.multiline?"m":"",o=o.source),-1===i.indexOf("g")&&(i+="g"),new t(function(){var t;return new r(function(){t=new RegExp(o,i)},function(){var e=t.exec(n);return e?this.Yield(e):!1},e.Blank)})},t.Range=function(e,n,o){return null==o&&(o=1),t.ToInfinity(e,o).Take(n)},t.RangeDown=function(e,n,o){return null==o&&(o=1),t.ToNegativeInfinity(e,o).Take(n)},t.RangeTo=function(e,n,o){return null==o&&(o=1),n>e?t.ToInfinity(e,o).TakeWhile(function(t){return n>=t}):t.ToNegativeInfinity(e,o).TakeWhile(function(t){return t>=n})},t.Repeat=function(n,o){return null!=o?t.Repeat(n).Take(o):new t(function(){return new r(e.Blank,function(){return this.Yield(n)},e.Blank)})},t.RepeatWithFinalize=function(e,n){return e=o.CreateLambda(e),n=o.CreateLambda(n),new t(function(){var t;return new r(function(){t=e()},function(){return this.Yield(t)},function(){null!=t&&(n(t),t=null)})})},t.Generate=function(n,i){return null!=i?t.Generate(n).Take(i):(n=o.CreateLambda(n),new t(function(){return new r(e.Blank,function(){return this.Yield(n())},e.Blank)}))},t.ToInfinity=function(n,o){return null==n&&(n=0),null==o&&(o=1),new t(function(){var t;return new r(function(){t=n-o},function(){return this.Yield(t+=o)},e.Blank)})},t.ToNegativeInfinity=function(n,o){return null==n&&(n=0),null==o&&(o=1),new t(function(){var t;return new r(function(){t=n+o},function(){return this.Yield(t-=o)},e.Blank)})},t.Unfold=function(n,i){return i=o.CreateLambda(i),new t(function(){var t,o=!0;return new r(e.Blank,function(){return o?(o=!1,t=n,this.Yield(t)):(t=i(t),this.Yield(t))},e.Blank)})},t.prototype={CascadeBreadthFirst:function(e,n){var i=this;return e=o.CreateLambda(e),n=o.CreateLambda(n),new t(function(){var a,u=0,s=[];return new r(function(){a=i.GetEnumerator()},function(){for(;;){if(a.MoveNext())return s.push(a.Current()),this.Yield(n(a.Current(),u));var i=t.From(s).SelectMany(function(t){return e(t)});if(!i.Any())return!1;u++,s=[],o.Dispose(a),a=i.GetEnumerator()}},function(){o.Dispose(a)})})},CascadeDepthFirst:function(e,n){var i=this;return e=o.CreateLambda(e),n=o.CreateLambda(n),new t(function(){var a,u=[];return new r(function(){a=i.GetEnumerator()},function(){for(;;){if(a.MoveNext()){var i=n(a.Current(),u.length);return u.push(a),a=t.From(e(a.Current())).GetEnumerator(),this.Yield(i)}if(u.length<=0)return!1;o.Dispose(a),a=u.pop()}},function(){try{o.Dispose(a)}finally{t.From(u).ForEach(function(t){t.Dispose()})}})})},Flatten:function(){var n=this;return new t(function(){var i,a=null;return new r(function(){i=n.GetEnumerator()},function(){for(;;){if(null!=a){if(a.MoveNext())return this.Yield(a.Current());a=null}if(i.MoveNext()){if(i.Current()instanceof Array){o.Dispose(a),a=t.From(i.Current()).SelectMany(e.Identity).Flatten().GetEnumerator();continue}return this.Yield(i.Current())}return!1}},function(){try{o.Dispose(i)}finally{o.Dispose(a)}})})},Pairwise:function(e){var n=this;return e=o.CreateLambda(e),new t(function(){var t;return new r(function(){t=n.GetEnumerator(),t.MoveNext()},function(){var n=t.Current();return t.MoveNext()?this.Yield(e(n,t.Current())):!1},function(){o.Dispose(t)})})},Scan:function(e,n,i){if(null!=i)return this.Scan(e,n).Select(i);var a;null==n?(n=o.CreateLambda(e),a=!1):(n=o.CreateLambda(n),a=!0);var u=this;return new t(function(){var t,i,s=!0;return new r(function(){t=u.GetEnumerator()},function(){if(s){if(s=!1,a)return this.Yield(i=e);if(t.MoveNext())return this.Yield(i=t.Current())}return t.MoveNext()?this.Yield(i=n(i,t.Current())):!1},function(){o.Dispose(t)})})},Select:function(e){var n=this;return e=o.CreateLambda(e),new t(function(){var t,i=0;return new r(function(){t=n.GetEnumerator()},function(){return t.MoveNext()?this.Yield(e(t.Current(),i++)):!1},function(){o.Dispose(t)})})},SelectMany:function(e,n){var i=this;return e=o.CreateLambda(e),null==n&&(n=function(t,e){return e}),n=o.CreateLambda(n),new t(function(){var a,u=void 0,s=0;return new r(function(){a=i.GetEnumerator()},function(){if(void 0===u&&!a.MoveNext())return!1;do{if(null==u){var i=e(a.Current(),s++);u=t.From(i).GetEnumerator()}if(u.MoveNext())return this.Yield(n(a.Current(),u.Current()));o.Dispose(u),u=null}while(a.MoveNext());return!1},function(){try{o.Dispose(a)}finally{o.Dispose(u)}})})},Where:function(e){e=o.CreateLambda(e);var n=this;return new t(function(){var t,i=0;return new r(function(){t=n.GetEnumerator()},function(){for(;t.MoveNext();)if(e(t.Current(),i++))return this.Yield(t.Current());return!1},function(){o.Dispose(t)})})},OfType:function(t){var e;switch(t){case Number:e=n.Number;break;case String:e=n.String;break;case Boolean:e=n.Boolean;break;case Function:e=n.Function;break;default:e=null}return null===e?this.Where(function(e){return e instanceof t}):this.Where(function(t){return typeof t===e})},Zip:function(e,n){n=o.CreateLambda(n);var i=this;return new t(function(){var a,u,s=0;return new r(function(){a=i.GetEnumerator(),u=t.From(e).GetEnumerator()},function(){return a.MoveNext()&&u.MoveNext()?this.Yield(n(a.Current(),u.Current(),s++)):!1},function(){try{o.Dispose(a)}finally{o.Dispose(u)}})})},Join:function(n,i,a,u,s){i=o.CreateLambda(i),a=o.CreateLambda(a),u=o.CreateLambda(u),s=o.CreateLambda(s);var c=this;return new t(function(){var d,l,h=null,p=0;return new r(function(){d=c.GetEnumerator(),l=t.From(n).ToLookup(a,e.Identity,s)},function(){for(;;){if(null!=h){var t=h[p++];if(void 0!==t)return this.Yield(u(d.Current(),t));t=null,p=0}if(!d.MoveNext())return!1;var e=i(d.Current());h=l.Get(e).ToArray()}},function(){o.Dispose(d)})})},GroupJoin:function(n,i,a,u,s){i=o.CreateLambda(i),a=o.CreateLambda(a),u=o.CreateLambda(u),s=o.CreateLambda(s);var c=this;return new t(function(){var d=c.GetEnumerator(),l=null;return new r(function(){d=c.GetEnumerator(),l=t.From(n).ToLookup(a,e.Identity,s)},function(){if(d.MoveNext()){var t=l.Get(i(d.Current()));return this.Yield(u(d.Current(),t))}return!1},function(){o.Dispose(d)})})},All:function(t){t=o.CreateLambda(t);var e=!0;return this.ForEach(function(n){return t(n)?void 0:(e=!1,!1)}),e},Any:function(t){t=o.CreateLambda(t);var e=this.GetEnumerator();try{if(0==arguments.length)return e.MoveNext();for(;e.MoveNext();)if(t(e.Current()))return!0;return!1}finally{o.Dispose(e)}},Concat:function(e){var n=this;return new t(function(){var i,a;return new r(function(){i=n.GetEnumerator()},function(){if(null==a){if(i.MoveNext())return this.Yield(i.Current());a=t.From(e).GetEnumerator()}return a.MoveNext()?this.Yield(a.Current()):!1},function(){try{o.Dispose(i)}finally{o.Dispose(a)}})})},Insert:function(e,n){var i=this;return new t(function(){var a,u,s=0,c=!1;return new r(function(){a=i.GetEnumerator(),u=t.From(n).GetEnumerator()},function(){return s==e&&u.MoveNext()?(c=!0,this.Yield(u.Current())):a.MoveNext()?(s++,this.Yield(a.Current())):!c&&u.MoveNext()?this.Yield(u.Current()):!1},function(){try{o.Dispose(a)}finally{o.Dispose(u)}})})},Alternate:function(e){return e=t.Return(e),this.SelectMany(function(n){return t.Return(n).Concat(e)}).TakeExceptLast()},Contains:function(t,e){e=o.CreateLambda(e);var n=this.GetEnumerator();try{for(;n.MoveNext();)if(e(n.Current())===t)return!0;return!1}finally{o.Dispose(n)}},DefaultIfEmpty:function(e){var n=this;return new t(function(){var t,i=!0;return new r(function(){t=n.GetEnumerator()},function(){return t.MoveNext()?(i=!1,this.Yield(t.Current())):i?(i=!1,this.Yield(e)):!1},function(){o.Dispose(t)})})},Distinct:function(e){return this.Except(t.Empty(),e)},Except:function(e,n){n=o.CreateLambda(n);var i=this;return new t(function(){var a,u;return new r(function(){a=i.GetEnumerator(),u=new d(n),t.From(e).ForEach(function(t){u.Add(t)})},function(){for(;a.MoveNext();){var t=a.Current();if(!u.Contains(t))return u.Add(t),this.Yield(t)}return!1},function(){o.Dispose(a)})})},Intersect:function(e,n){n=o.CreateLambda(n);var i=this;return new t(function(){var a,u,s;return new r(function(){a=i.GetEnumerator(),u=new d(n),t.From(e).ForEach(function(t){u.Add(t)}),s=new d(n)},function(){for(;a.MoveNext();){var t=a.Current();if(!s.Contains(t)&&u.Contains(t))return s.Add(t),this.Yield(t)}return!1},function(){o.Dispose(a)})})},SequenceEqual:function(e,n){n=o.CreateLambda(n);var i=this.GetEnumerator();try{var r=t.From(e).GetEnumerator();try{for(;i.MoveNext();)if(!r.MoveNext()||n(i.Current())!==n(r.Current()))return!1;return r.MoveNext()?!1:!0}finally{o.Dispose(r)}}finally{o.Dispose(i)}},Union:function(e,n){n=o.CreateLambda(n);var i=this;return new t(function(){var a,u,s;return new r(function(){a=i.GetEnumerator(),s=new d(n)},function(){var n;if(void 0===u){for(;a.MoveNext();)if(n=a.Current(),!s.Contains(n))return s.Add(n),this.Yield(n);u=t.From(e).GetEnumerator()}for(;u.MoveNext();)if(n=u.Current(),!s.Contains(n))return s.Add(n),this.Yield(n);return!1},function(){try{o.Dispose(a)}finally{o.Dispose(u)}})})},OrderBy:function(t){return new u(this,t,!1)},OrderByDescending:function(t){return new u(this,t,!0)},Reverse:function(){var n=this;return new t(function(){var t,o;return new r(function(){t=n.ToArray(),o=t.length},function(){return o>0?this.Yield(t[--o]):!1},e.Blank)})},Shuffle:function(){var n=this;return new t(function(){var t;return new r(function(){t=n.ToArray()},function(){if(t.length>0){var e=Math.floor(Math.random()*t.length);return this.Yield(t.splice(e,1)[0])}return!1},e.Blank)})},GroupBy:function(e,n,i,a){var u=this;return e=o.CreateLambda(e),n=o.CreateLambda(n),null!=i&&(i=o.CreateLambda(i)),a=o.CreateLambda(a),new t(function(){var t;return new r(function(){t=u.ToLookup(e,n,a).ToEnumerable().GetEnumerator()},function(){for(;t.MoveNext();)return null==i?this.Yield(t.Current()):this.Yield(i(t.Current().Key(),t.Current()));return!1},function(){o.Dispose(t)})})},PartitionBy:function(e,n,i,a){var u=this;e=o.CreateLambda(e),n=o.CreateLambda(n),a=o.CreateLambda(a);var s;return null==i?(s=!1,i=function(t,e){return new h(t,e)}):(s=!0,i=o.CreateLambda(i)),new t(function(){var c,d,l,h=[];return new r(function(){c=u.GetEnumerator(),c.MoveNext()&&(d=e(c.Current()),l=a(d),h.push(n(c.Current())))},function(){for(var o;1==(o=c.MoveNext())&&l===a(e(c.Current()));)h.push(n(c.Current()));if(h.length>0){var r=s?i(d,t.From(h)):i(d,h);return o?(d=e(c.Current()),l=a(d),h=[n(c.Current())]):h=[],this.Yield(r)}return!1},function(){o.Dispose(c)})})},BufferWithCount:function(e){var n=this;return new t(function(){var t;return new r(function(){t=n.GetEnumerator()},function(){for(var n=[],o=0;t.MoveNext();)if(n.push(t.Current()),++o>=e)return this.Yield(n);return n.length>0?this.Yield(n):!1},function(){o.Dispose(t)})})},Aggregate:function(t,e,n){return this.Scan(t,e,n).Last()},Average:function(t){t=o.CreateLambda(t);var e=0,n=0;return this.ForEach(function(o){e+=t(o),++n}),e/n},Count:function(t){t=null==t?e.True:o.CreateLambda(t);var n=0;return this.ForEach(function(e,o){t(e,o)&&++n}),n},Max:function(t){return null==t&&(t=e.Identity),this.Select(t).Aggregate(function(t,e){return t>e?t:e})},Min:function(t){return null==t&&(t=e.Identity),this.Select(t).Aggregate(function(t,e){return e>t?t:e})},MaxBy:function(t){return t=o.CreateLambda(t),this.Aggregate(function(e,n){return t(e)>t(n)?e:n})},MinBy:function(t){return t=o.CreateLambda(t),this.Aggregate(function(e,n){return t(e)<t(n)?e:n})},Sum:function(t){return null==t&&(t=e.Identity),this.Select(t).Aggregate(0,function(t,e){return t+e})},ElementAt:function(t){var e,n=!1;if(this.ForEach(function(o,i){return i==t?(e=o,n=!0,!1):void 0}),!n)throw new Error("index is less than 0 or greater than or equal to the number of elements in source.");return e},ElementAtOrDefault:function(t,e){var n,o=!1;return this.ForEach(function(e,i){return i==t?(n=e,o=!0,!1):void 0}),o?n:e},First:function(t){if(null!=t)return this.Where(t).First();var e,n=!1;if(this.ForEach(function(t){return e=t,n=!0,!1}),!n)throw new Error("First:No element satisfies the condition.");return e},FirstOrDefault:function(t,e){if(null!=e)return this.Where(e).FirstOrDefault(t);var n,o=!1;return this.ForEach(function(t){return n=t,o=!0,!1}),o?n:t},Last:function(t){if(null!=t)return this.Where(t).Last();var e,n=!1;if(this.ForEach(function(t){n=!0,e=t}),!n)throw new Error("Last:No element satisfies the condition.");return e},LastOrDefault:function(t,e){if(null!=e)return this.Where(e).LastOrDefault(t);var n,o=!1;return this.ForEach(function(t){o=!0,n=t}),o?n:t},Single:function(t){if(null!=t)return this.Where(t).Single();var e,n=!1;if(this.ForEach(function(t){if(n)throw new Error("Single:sequence contains more than one element.");n=!0,e=t}),!n)throw new Error("Single:No element satisfies the condition.");return e},SingleOrDefault:function(t,e){if(null!=e)return this.Where(e).SingleOrDefault(t);var n,o=!1;return this.ForEach(function(t){if(o)throw new Error("Single:sequence contains more than one element.");o=!0,n=t}),o?n:t},Skip:function(e){var n=this;return new t(function(){var t,i=0;return new r(function(){for(t=n.GetEnumerator();i++<e&&t.MoveNext(););},function(){return t.MoveNext()?this.Yield(t.Current()):!1},function(){o.Dispose(t)})})},SkipWhile:function(e){e=o.CreateLambda(e);var n=this;return new t(function(){var t,i=0,a=!1;return new r(function(){t=n.GetEnumerator()},function(){for(;!a;){if(!t.MoveNext())return!1;if(!e(t.Current(),i++))return a=!0,this.Yield(t.Current())}return t.MoveNext()?this.Yield(t.Current()):!1},function(){o.Dispose(t)})})},Take:function(e){var n=this;return new t(function(){var t,i=0;return new r(function(){t=n.GetEnumerator()},function(){return i++<e&&t.MoveNext()?this.Yield(t.Current()):!1},function(){o.Dispose(t)})})},TakeWhile:function(e){e=o.CreateLambda(e);var n=this;return new t(function(){var t,i=0;return new r(function(){t=n.GetEnumerator()},function(){return t.MoveNext()&&e(t.Current(),i++)?this.Yield(t.Current()):!1},function(){o.Dispose(t)})})},TakeExceptLast:function(e){null==e&&(e=1);var n=this;return new t(function(){if(0>=e)return n.GetEnumerator();var t,i=[];return new r(function(){t=n.GetEnumerator()},function(){for(;t.MoveNext();){if(i.length==e)return i.push(t.Current()),this.Yield(i.shift());i.push(t.Current())}return!1},function(){o.Dispose(t)})})},TakeFromLast:function(e){if(0>=e||null==e)return t.Empty();var n=this;return new t(function(){var i,a,u=[];return new r(function(){i=n.GetEnumerator()},function(){for(;i.MoveNext();)u.length==e&&u.shift(),u.push(i.Current());return null==a&&(a=t.From(u).GetEnumerator()),a.MoveNext()?this.Yield(a.Current()):!1},function(){o.Dispose(a)})})},IndexOf:function(t){var e=null;return this.ForEach(function(n,o){return n===t?(e=o,!0):void 0}),null!==e?e:-1},LastIndexOf:function(t){var e=-1;return this.ForEach(function(n,o){n===t&&(e=o)}),e},ToArray:function(){var t=[];return this.ForEach(function(e){t.push(e)}),t},ToLookup:function(t,e,n){t=o.CreateLambda(t),e=o.CreateLambda(e),n=o.CreateLambda(n);var i=new d(n);return this.ForEach(function(n){var o=t(n),r=e(n),a=i.Get(o);void 0!==a?a.push(r):i.Add(o,[r])}),new l(i)},ToObject:function(t,e){t=o.CreateLambda(t),e=o.CreateLambda(e);var n={};return this.ForEach(function(o){n[t(o)]=e(o)}),n},ToDictionary:function(t,e,n){t=o.CreateLambda(t),e=o.CreateLambda(e),n=o.CreateLambda(n);var i=new d(n);return this.ForEach(function(n){i.Add(t(n),e(n))}),i},ToJSON:function(t,e){return JSON.stringify(this.ToArray(),t,e)},ToString:function(t,n){return null==t&&(t=""),null==n&&(n=e.Identity),this.Select(n).ToArray().join(t)},Do:function(e){var n=this;return e=o.CreateLambda(e),new t(function(){var t,i=0;return new r(function(){t=n.GetEnumerator()},function(){return t.MoveNext()?(e(t.Current(),i++),this.Yield(t.Current())):!1},function(){o.Dispose(t)})})},ForEach:function(t){t=o.CreateLambda(t);var e=0,n=this.GetEnumerator();try{for(;n.MoveNext()&&t(n.Current(),e++)!==!1;);}finally{o.Dispose(n)}},Write:function(t,e){null==t&&(t=""),e=o.CreateLambda(e);var n=!0;this.ForEach(function(o){n?n=!1:document.write(t),document.write(e(o))})},WriteLine:function(t){t=o.CreateLambda(t),this.ForEach(function(e){document.write(t(e)),document.write("<br />")})},Force:function(){var t=this.GetEnumerator();try{for(;t.MoveNext(););}finally{o.Dispose(t)}},Let:function(e){e=o.CreateLambda(e);var n=this;return new t(function(){var i;return new r(function(){i=t.From(e(n)).GetEnumerator()},function(){return i.MoveNext()?this.Yield(i.Current()):!1},function(){o.Dispose(i)})})},Share:function(){var n,o=this;return new t(function(){return new r(function(){null==n&&(n=o.GetEnumerator())},function(){return n.MoveNext()?this.Yield(n.Current()):!1},e.Blank)})},MemoizeAll:function(){var n,o,i=this;return new t(function(){var t=-1;return new r(function(){null==o&&(o=i.GetEnumerator(),n=[])},function(){return t++,n.length<=t?o.MoveNext()?this.Yield(n[t]=o.Current()):!1:this.Yield(n[t])},e.Blank)})},Catch:function(e){e=o.CreateLambda(e);var n=this;return new t(function(){var t;return new r(function(){t=n.GetEnumerator()},function(){try{return t.MoveNext()?this.Yield(t.Current()):!1}catch(n){return e(n),!1}},function(){o.Dispose(t)})})},Finally:function(e){e=o.CreateLambda(e);var n=this;return new t(function(){var t;return new r(function(){t=n.GetEnumerator()},function(){return t.MoveNext()?this.Yield(t.Current()):!1},function(){try{o.Dispose(t)}finally{e()}})})},Trace:function(t,e){return null==t&&(t="Trace"),e=o.CreateLambda(e),this.Do(function(n){console.log(t,":",e(n))})}};var e={Identity:function(t){return t},True:function(){return!0},Blank:function(){}},n={Boolean:typeof!0,Number:"number",String:"string",Object:typeof{},Undefined:"undefined",Function:"function"},o={CreateLambda:function(t){if(null==t)return e.Identity;if(typeof t==n.String){if(""==t)return e.Identity;if(-1==t.indexOf("=>"))return new Function("$,$$,$$$,$$$$","return "+t);var o=t.match(/^[(\s]*([^()]*?)[)\s]*=>(.*)/);return new Function(o[1],"return "+o[2])}return t},IsIEnumerable:function(t){if(typeof Enumerator!=n.Undefined)try{return new Enumerator(t),!0}catch(e){}return!1},Compare:function(t,e){return t===e?0:t>e?1:-1},Dispose:function(t){null!=t&&t.Dispose()}},i={Before:0,Running:1,After:2},r=function(t,e,n){var o=new a,r=i.Before;this.Current=o.Current,this.MoveNext=function(){try{switch(r){case i.Before:r=i.Running,t();case i.Running:return e.apply(o)?!0:(this.Dispose(),!1);case i.After:return!1}}catch(n){throw this.Dispose(),n}},this.Dispose=function(){if(r==i.Running)try{n()}finally{r=i.After}}},a=function(){var t=null;this.Current=function(){return t},this.Yield=function(e){return t=e,!0}},u=function(t,e,n,i){this.source=t,this.keySelector=o.CreateLambda(e),this.descending=n,this.parent=i};u.prototype=new t,u.prototype.CreateOrderedEnumerable=function(t,e){return new u(this.source,t,e,this)},u.prototype.ThenBy=function(t){return this.CreateOrderedEnumerable(t,!1)},u.prototype.ThenByDescending=function(t){return this.CreateOrderedEnumerable(t,!0)},u.prototype.GetEnumerator=function(){var t,n,o=this,i=0;return new r(function(){t=[],n=[],o.source.ForEach(function(e,o){t.push(e),n.push(o)});var e=s.Create(o,null);e.GenerateKeys(t),n.sort(function(t,n){return e.Compare(t,n)})},function(){return i<n.length?this.Yield(t[n[i++]]):!1},e.Blank)};var s=function(t,e,n){this.keySelector=t,this.descending=e,this.child=n,this.keys=null};s.Create=function(t,e){var n=new s(t.keySelector,t.descending,e);return null!=t.parent?s.Create(t.parent,n):n},s.prototype.GenerateKeys=function(t){for(var e=t.length,n=this.keySelector,o=new Array(e),i=0;e>i;i++)o[i]=n(t[i]);this.keys=o,null!=this.child&&this.child.GenerateKeys(t)},s.prototype.Compare=function(t,e){var n=o.Compare(this.keys[t],this.keys[e]);if(0==n){if(null!=this.child)return this.child.Compare(t,e);n=o.Compare(t,e)}return this.descending?-n:n};var c=function(t){this.source=t};c.prototype=new t,c.prototype.Any=function(e){return null==e?this.source.length>0:t.prototype.Any.apply(this,arguments)},c.prototype.Count=function(e){return null==e?this.source.length:t.prototype.Count.apply(this,arguments)},c.prototype.ElementAt=function(e){return e>=0&&e<this.source.length?this.source[e]:t.prototype.ElementAt.apply(this,arguments)},c.prototype.ElementAtOrDefault=function(t,e){return t>=0&&t<this.source.length?this.source[t]:e},c.prototype.First=function(e){return null==e&&this.source.length>0?this.source[0]:t.prototype.First.apply(this,arguments)},c.prototype.FirstOrDefault=function(e,n){return null!=n?t.prototype.FirstOrDefault.apply(this,arguments):this.source.length>0?this.source[0]:e},c.prototype.Last=function(e){return null==e&&this.source.length>0?this.source[this.source.length-1]:t.prototype.Last.apply(this,arguments)},c.prototype.LastOrDefault=function(e,n){return null!=n?t.prototype.LastOrDefault.apply(this,arguments):this.source.length>0?this.source[this.source.length-1]:e},c.prototype.Skip=function(n){var o=this.source;return new t(function(){var t;return new r(function(){t=0>n?0:n},function(){return t<o.length?this.Yield(o[t++]):!1},e.Blank)})},c.prototype.TakeExceptLast=function(t){return null==t&&(t=1),this.Take(this.source.length-t)},c.prototype.TakeFromLast=function(t){return this.Skip(this.source.length-t)},c.prototype.Reverse=function(){var n=this.source;return new t(function(){var t;return new r(function(){t=n.length},function(){return t>0?this.Yield(n[--t]):!1},e.Blank)})},c.prototype.SequenceEqual=function(e,n){return(e instanceof c||e instanceof Array)&&null==n&&t.From(e).Count()!=this.Count()?!1:t.prototype.SequenceEqual.apply(this,arguments)},c.prototype.ToString=function(e,n){return null==n&&this.source instanceof Array?(null==e&&(e=""),this.source.join(e)):t.prototype.ToString.apply(this,arguments)},c.prototype.GetEnumerator=function(){var t=this.source,n=0;return new r(e.Blank,function(){return n<t.length?this.Yield(t[n++]):!1},e.Blank)};var d=function(){var o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i=function(t){return null===t?"null":void 0===t?"undefined":typeof t.toString===n.Function?t.toString():Object.prototype.toString.call(t)},a=function(t,e){this.Key=t,this.Value=e,this.Prev=null,this.Next=null},u=function(){this.First=null,this.Last=null};u.prototype={AddLast:function(t){null!=this.Last?(this.Last.Next=t,t.Prev=this.Last,this.Last=t):this.First=this.Last=t},Replace:function(t,e){null!=t.Prev?(t.Prev.Next=e,e.Prev=t.Prev):this.First=e,null!=t.Next?(t.Next.Prev=e,e.Next=t.Next):this.Last=e},Remove:function(t){null!=t.Prev?t.Prev.Next=t.Next:this.First=t.Next,null!=t.Next?t.Next.Prev=t.Prev:this.Last=t.Prev}};var s=function(t){this.count=0,this.entryList=new u,this.buckets={},this.compareSelector=null==t?e.Identity:t};return s.prototype={Add:function(t,e){var n=this.compareSelector(t),r=i(n),u=new a(t,e);if(o(this.buckets,r)){for(var s=this.buckets[r],c=0;c<s.length;c++)if(this.compareSelector(s[c].Key)===n)return this.entryList.Replace(s[c],u),void(s[c]=u);s.push(u)}else this.buckets[r]=[u];this.count++,this.entryList.AddLast(u)},Get:function(t){var e=this.compareSelector(t),n=i(e);if(o(this.buckets,n))for(var r=this.buckets[n],a=0;a<r.length;a++){var u=r[a];if(this.compareSelector(u.Key)===e)return u.Value}},Set:function(t,e){var n=this.compareSelector(t),r=i(n);if(o(this.buckets,r))for(var u=this.buckets[r],s=0;s<u.length;s++)if(this.compareSelector(u[s].Key)===n){var c=new a(t,e);return this.entryList.Replace(u[s],c),u[s]=c,!0}return!1},Contains:function(t){var e=this.compareSelector(t),n=i(e);if(!o(this.buckets,n))return!1;for(var r=this.buckets[n],a=0;a<r.length;a++)if(this.compareSelector(r[a].Key)===e)return!0;return!1},Clear:function(){this.count=0,this.buckets={},this.entryList=new u},Remove:function(t){var e=this.compareSelector(t),n=i(e);if(o(this.buckets,n))for(var r=this.buckets[n],a=0;a<r.length;a++)if(this.compareSelector(r[a].Key)===e)return this.entryList.Remove(r[a]),r.splice(a,1),0==r.length&&delete this.buckets[n],void this.count--},Count:function(){return this.count},ToEnumerable:function(){var n=this;return new t(function(){var t;return new r(function(){t=n.entryList.First},function(){if(null!=t){var e={Key:t.Key,Value:t.Value};return t=t.Next,this.Yield(e)}return!1},e.Blank)})}},s}(),l=function(e){this.Count=function(){return e.Count()},this.Get=function(n){return t.From(e.Get(n))},this.Contains=function(t){return e.Contains(t)},this.ToEnumerable=function(){return e.ToEnumerable().Select(function(t){return new h(t.Key,t.Value)})}},h=function(t,e){this.Key=function(){return t},c.call(this,e)};return h.prototype=new c,t}();var Sound=function(){var t=this;t.isPause=!1,t.list={},arguments[0]instanceof Array&&t.loadList(arguments[0])};Sound.prototype.loadList=function(t){for(var e,n=this,o=0;e=t[o];o++)e.src.indexOf(".mp3")>-1&&(n.list[e.key]=e.entity)},Sound.prototype.play=function(t,e){var n=this,o=n.list[t];if("undefined"!=typeof o){o.loop=!!e;try{o.currentTime=0}catch(i){}o.play()}},Sound.prototype.playAll=function(){var t=this;for(key in t.list)t.list[key].play()},Sound.prototype.pause=function(){var t=this;t.isPause=!0;for(key in t.list)t.list[key].pause()},Sound.prototype["continue"]=function(){var t=this;t.isPause=!1;for(key in t.list)t.list[key].play()},Sound.prototype.stop=function(){var t=this;for(key in t.list){var e=t.list[key];e.pause(),e.currentTime=0}},Sound.prototype.fixIOSCantPlay=function(){var t=this;t.playAll(),t.stop()},Sound.prototype.arraybufferToBase64=function(t){return URL.createObjectURL(new Blob([new Uint8Array(t)],{type:"audio/mpeg"}))};var IEventObject=function(){};IEventObject.prototype.addEventListener=function(t,e){throw new Error("not implement")},IEventObject.prototype.removeEventListener=function(t,e){throw new Error("not implement")},IEventObject.prototype.dispatchEvent=function(t,e){throw new Error("not implement")};var AEventObject=function(){IEventObject.apply(this,arguments),this.listeners=[]};AEventObject.prototype=Object.create(IEventObject.prototype),AEventObject.prototype.addEventListener=function(t,e){var n=this;n.listeners.push({type:t,listeners:e})},AEventObject.prototype.removeEventListener=function(t,e){var n=this,o=arguments[1],i=[];"function"==typeof arguments[0]&&(o=t);for(var r,a=0;r=n.listeners[a];a++){var u=null;"string"==typeof arguments[0]&&"function"==typeof arguments[1]?u=r:"function"==typeof arguments[0]&&(u=r),u&&i.push(u)}for(var r,a=0;r=i[a];a++)n.listeners.splice(n.listeners.indexOf(r),1)},AEventObject.prototype.dispatchEvent=function(t,e){for(var n,o=this,i=0;n=o.listeners[i];i++)n.type===t&&n.listeners(e)};var Resource=function(){AEventObject.apply(this,arguments),this.list=[],this.isComplete=!1,this._loaded=0,arguments[0]instanceof Object&&Object.assign(this,arguments[0])};Resource.prototype=Object.create(AEventObject.prototype),Resource.prototype.ajax=function(t){var e=new XMLHttpRequest,n=Object.assign({url:"",method:"GET",body:null,onLoad:function(t){},onError:function(t){},onComplete:function(t){}},t);e.addEventListener("load",function(t){n.onLoad(this)}),e.addEventListener("error",function(t){n.onError(this)}),e.addEventListener("complete",function(t){n.onComplete(this)}),e.open(n.method,n.url),e.responseType="arraybuffer",e.send(n.body)},Resource.prototype.httpGet=function(t,e){var n=this;n.ajax({url:t,method:"GET",onLoad:e})},Resource.prototype.httpPost=function(t,e,n){var o=this;o.ajax({url:t,method:"POST",body:e,onLoad:n})},Resource.prototype.httpPut=function(t,e,n){var o=this;o.ajax({url:t,method:"PUT",body:e,fnOnLoad:n})},Resource.prototype.httpDelete=function(t,e){var n=this;n.ajax({url:t,method:"DELETE",fnOnLoad:fnOnLoad})},Resource.prototype.loadAll=function(){for(var t,e=this,n=0;t=e.list[n];n++)e.load(t)},Resource.prototype.load=function(t){var e=this,n=null;if(t instanceof String?n=e.get(t):t instanceof Object&&(n=t),n){if(n.src.indexOf(".png")>-1){var o=new Image;o.addEventListener("load",function(t){e.waitLoad()}),o.src=n.src,n.entity=o}if(n.src.indexOf(".mp3")>-1){var i=new Audio;i.addEventListener("canplay",function(t){}),i.src=n.src,n.entity=i,e.waitLoad()}}},Resource.prototype.waitLoad=function(){var t=this;
++t._loaded===t.list.length&&(t.isComplete=!0,t.dispatchEvent("complete",{target:t}))},Resource.prototype.add=function(t,e){var n=this,o=n.get(t);if(!o){var i={key:t,src:e,binary:[],contentType:""};n.list.push(i),n.load(i)}},Resource.prototype.get=function(t){for(var e,n=this,o=0;e=n.list[o];o++)if(e.key===t)return e;return null},Resource.prototype.getBase64=function(t){var e=this,n=e.get(t);return n?e.arrayBufferToBase64(n.binary,n.contentType):null},Resource.prototype.remove=function(t){var e=this;e.list.splice(e.list.indexOf(e.get(t)),1)},Resource.prototype.arrayBufferToBase64=function(t,e){return URL.createObjectURL(new Blob([new Uint8Array(t)],{type:e}))};var DataBus=function(){this.scale=1,this.sound=new Sound,this.resource=new Resource,this.list=[],this.removeList=[]};DataBus.prototype.add=function(t){this.list.push(t)},DataBus.prototype.remove=function(t){this.removeList.push(t)},DataBus.prototype.execRemove=function(t){for(var e,n=0;e=this.removeList[n];n++){var o=this.list.indexOf(e);o>-1&&this.list.splice(o,1)}},DataBus.prototype.broadcast=function(t,e){for(var n,o=0;n=this.list[o];o++)n.dispacthEvent(t,e)};var dataBus=new DataBus,AModel=function(){AEventObject.apply(this,arguments);var t=this;if(t.width=0,t.height=0,t.position={x:0,y:0},t.sWidth=0,t.sHeight=0,t.sPosition={x:0,y:0},t.rotate=0,t.scale=1,t.speed=0,t.image=null,"object"==typeof arguments[0])for(p in arguments[0])t[p]=arguments[0][p]};AModel.prototype=Object.create(AEventObject.prototype),AModel.prototype.getBox=function(){var t=this;return{leftTop:t.position,rightTop:{x:t.position.x+t.width,y:t.position.y},rightBottom:{x:t.position.x+t.width,y:t.position.y+t.height},leftBottom:{x:t.position.x,y:t.position.y+t.height}}},AModel.prototype.inBox=function(t){var e=this;return t.x>=e.position.x&&t.x<=e.position.x+e.width&&t.y>=e.position.y&&t.y<=e.position.y+e.height?!0:!1},AModel.prototype.getCenter=function(){var t=this;return{x:t.position.x+t.width/2,y:t.position.y+t.height/2}},AModel.prototype.onFrame=function(t){var e=this,n=e.getCollision(e);n&&(e.dispatchEvent("collision",{target:n}),n.dispatchEvent("collision",{target:e}))},AModel.prototype.getCollision=function(t){for(var e,n=this,o=0;e=dataBus.list[o];o++)if(!(e instanceof Background)&&e!==t&&n.isEgdeCollision(e,t))return e;return null},AModel.prototype.isEgdeCollision=function(t,e){return t.position.x<e.position.x+e.width&&t.position.x+t.width>e.position.x&&t.position.y<e.position.y+e.height&&t.height+t.position.y>e.position.y?!0:!1};var ABullet=function(){AModel.apply(this,arguments);var t=this;dataBus.sound.play("bullet"),t.addEventListener("frame",function(e){t.onFrame(e)}),t.addEventListener("collision",function(e){t.onCollision(e)})};ABullet.prototype=Object.create(AModel.prototype),ABullet.prototype.onFrame=function(t){var e=this;e.position.y-=e.speed,AModel.prototype.onFrame.apply(this,arguments),e.position.y+e.height<0&&dataBus.remove(e)},ABullet.prototype.onCollision=function(t){var e=this;e.owner!==t.target&&t.target instanceof AEnemy&&dataBus.remove(e)};var Background=function(){AModel.apply(this,arguments);var t=this;t.image=dataBus.resource.get("bg").entity,t.width=640,t.height=1136,t.sWidth=t.width,t.sHeight=t.height,t.name="Background",t.resize(),t.addEventListener("frame",function(e){t.onFrame(e)})};Background.prototype=Object.create(AModel.prototype),Background.prototype.resize=function(){var t=this,e=t.height/t.width;t.width=t.windowWidth,t.height=t.windowWidth*e},Background.prototype.onFrame=function(){var t=this;t.position.y+=.1,t.position.y>=t.windowHeight&&(t.position.y=t.windowHeight-t.height-t.height)};var Face=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("face").entity,e.width=640,e.height=1136,e.sWidth=640,e.sHeight=1136};Face.prototype=Object.create(AModel.prototype);var Dialog=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("common").entity,e.width=200,e.height=200,e.sWidth=200,e.sHeight=200};Dialog.prototype=Object.create(AModel.prototype);var Button=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("common").entity,e.width=79,e.height=20,e.sWidth=83,e.sHeight=21,e.sPosition={x:201,y:0}};Button.prototype=Object.create(AModel.prototype),Button.prototype.onAfterFrame=function(t){var e=this,n=t.target.context,o=e.height/2,i=e.text.length*o;n.save(),n.font=o+"px Arial",n.fillText(e.text,e.position.x+(e.width-i)/2,e.position.y+(e.height+o/2)/2),n.restore()};var Bullet1=function(t){ABullet.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=13*dataBus.scale,e.height=28*dataBus.scale,e.sWidth=13,e.sHeight=28,e.sPosition.x=1027,e.sPosition.y=1107,e.speed=10,e.name="Bullet1"};Bullet1.prototype=Object.create(ABullet.prototype);var Bullet2=function(t){ABullet.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=13*dataBus.scale,e.height=28*dataBus.scale,e.sWidth=13,e.sHeight=28,e.sPosition={x:1007,y:1107},e.speed=10,e.name="Bullet2"};Bullet2.prototype=Object.create(ABullet.prototype);var Plane=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=128*dataBus.scale,e.height=166*dataBus.scale,e.sWidth=128,e.sHeight=166,e.sPosition.x=640,e.bulletType=1,e.speed=3,e.hp=1,e.name="plane",e.bombs=0,e.lastAnimation=Date.now(),e.explodeAnimationTotal=5,e.firedTime=0,e.bombTime=0,e.addEventListener("collision",function(t){t.target instanceof AEnemy?e.hp>0&&(--e.hp,0===e.hp&&(e.sPosition.y=2*e.sHeight)):t.target instanceof DoubleLaser?(dataBus.sound.play("getdoublelaser"),1===e.bulletType?e.bulletType=2:e.bulletType=1,dataBus.remove(t.target)):t.target instanceof Bomb&&e.bombs<9&&(dataBus.sound.play("getbomb"),e.bombs++,dataBus.remove(t.target))})};Plane.prototype=Object.create(AModel.prototype),Plane.prototype.fire=function(){var t=this;if(Date.now()-t.firedTime<200)return[];if(t.firedTime=Date.now(),1===t.bulletType){var e=t.getCenter();e.y=t.position.y;var n=new Bullet1({position:e,owner:t});return n.position.x-=n.width/2,[n]}var o=new Bullet2({position:{x:t.position.x,y:t.position.y+t.height/2},owner:t}),i=new Bullet2({position:{x:t.position.x+t.width,y:t.position.y+t.height/2},owner:t});return o.position.x-=o.width/2,i.position.x-=i.width/2,[o,i]},Plane.prototype.dropBomb=function(){var t=this;Date.now()-t.bombTime<200||0===t.bombs||(t.dispatchEvent("dropBomb",{target:t}),dataBus.sound.play("usebomb"),t.bombs--,t.bombTime=Date.now())},Plane.prototype.onFrame=function(t){var e=this;e.hp>0&&e.normalAnimation(),0===e.hp&&e.explodeAnimation(),AModel.prototype.onFrame.apply(this,arguments)},Plane.prototype.normalAnimation=function(){var t=this;Date.now()-t.lastAnimation>500&&(0===t.sPosition.y?t.sPosition.y=t.sHeight:t.sPosition.y=0,t.lastAnimation=Date.now())},Plane.prototype.explodeAnimation=function(){var t=this;if(Date.now()-t.lastAnimation>100){if(t.sPosition.y===2*t.sHeight&&dataBus.sound.play("gameover"),t.sPosition.y===t.explodeAnimationTotal*t.sHeight)return void t.onExplode();t.sPosition.y+=t.sHeight,t.lastAnimation=Date.now()}},Plane.prototype.onExplode=function(){var t=this;t.dispatchEvent("explode")};var AEnemy=function(){AModel.apply(this,arguments)};AEnemy.prototype=Object.create(AModel.prototype);var Enemy1=function(t){AEnemy.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=63*dataBus.scale,e.height=50*dataBus.scale,e.sWidth=63,e.sHeight=50,e.sPosition.x=768,e.rotate=180,e.speed=3,e.name="Enemy1",e.hp=1,e.explodeAnimationTotal=4,e.lastAnimation=0,e.addEventListener("collision",function(t){t.target instanceof ABullet&&e.hp>0&&--e.hp})};Enemy1.prototype=Object.create(AEnemy.prototype),Enemy1.prototype.onFrame=function(t){var e=this;e.hp>0&&(e.position.y+=e.speed),e.position.y>1136&&dataBus.remove(e),0===e.hp&&e.explodeAnimation(),AEnemy.prototype.onFrame.apply(this,arguments)},Enemy1.prototype.explodeAnimation=function(){var t=this;if(t.sPosition.y===t.sHeight&&dataBus.sound.play("enemy1down"),Date.now()-t.lastAnimation>100){if(t.sPosition.y===t.explodeAnimationTotal*t.sHeight)return void t.onExplode();t.sPosition.y+=t.sHeight,t.lastAnimation=Date.now()}},Enemy1.prototype.onExplode=function(){var t=this;t.dispatchEvent("explode"),dataBus.remove(t)};var Enemy2=function(t){AEnemy.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=90*dataBus.scale,e.height=115*dataBus.scale,e.sWidth=90,e.sHeight=115,e.sPosition.x=834,e.rotate=180,e.speed=3,e.name="Enemy2",e.hp=3,e.explodeAnimationTotal=5,e.lastAnimation=0,e.addEventListener("collision",function(t){t.target instanceof ABullet&&e.hp>0&&--e.hp})};Enemy2.prototype=Object.create(AEnemy.prototype),Enemy2.prototype.onFrame=function(t){var e=this;e.hp>0&&(e.position.y+=e.speed),e.position.y>1136&&dataBus.remove(e),2===e.hp&&e.damageAnimation(),0===e.hp&&e.explodeAnimation(),AEnemy.prototype.onFrame.apply(this,arguments)},Enemy2.prototype.damageAnimation=function(){var t=this;t.sPosition.y=t.sHeight},Enemy2.prototype.explodeAnimation=function(){var t=this;if(t.sPosition.y===2*t.sHeight&&dataBus.sound.play("enemy3down"),Date.now()-t.lastAnimation>100){if(t.sPosition.y===t.explodeAnimationTotal*t.sHeight)return void t.onExplode();t.sPosition.y+=t.sHeight,t.lastAnimation=Date.now()}},Enemy2.prototype.onExplode=function(){var t=this;t.dispatchEvent("explode"),dataBus.remove(t)};var Enemy3=function(t){AEnemy.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=218*dataBus.scale,e.height=330*dataBus.scale,e.sWidth=218,e.sHeight=330,e.sPosition.x=926,e.rotate=180,e.speed=3,e.name="Enemy3",e.hp=5,e.explodeAnimationTotal=6,e.normalAnimationTotal=1,e.lastAnimation=0,dataBus.sound.play("enemy2out"),e.addEventListener("collision",function(t){t.target instanceof ABullet&&e.hp>0&&--e.hp})};Enemy3.prototype=Object.create(AEnemy.prototype),Enemy3.prototype.onFrame=function(t){var e=this;e.hp>0&&(e.position.y+=e.speed),e.position.y>1136&&dataBus.remove(e),e.hp>3?e.normalAnimation():3===e.hp&&e.damageAnimation(),0===e.hp&&e.explodeAnimation(),AEnemy.prototype.onFrame.apply(this,arguments)},Enemy3.prototype.normalAnimation=function(){var t=this;Date.now()-t.lastAnimation>500&&(0===t.sPosition.y?t.sPosition.y=t.sHeight:t.sPosition.y=0,t.lastAnimation=Date.now())},Enemy3.prototype.damageAnimation=function(){var t=this;t.sPosition.y=2*t.sHeight},Enemy3.prototype.explodeAnimation=function(){var t=this;if(926===t.sPosition.x&&(dataBus.sound.play("enemy2down"),t.sPosition={x:926+t.sWidth,y:1}),Date.now()-t.lastAnimation>100){if(t.sPosition.x===926+t.explodeAnimationTotal*t.sWidth)return void t.onExplode();t.sPosition.x+=t.sWidth,t.lastAnimation=Date.now()}},Enemy3.prototype.onExplode=function(){var t=this;t.dispatchEvent("explode"),dataBus.remove(t)};var APowerUp=function(){AModel.apply(this,arguments),this.status="showdown"};APowerUp.prototype=Object.create(AModel.prototype),APowerUp.prototype.playAnimation=function(){"showdown"===this.status||"showup"===this.status?this.showAnimation():this.downAnimation()},APowerUp.prototype.showAnimation=function(){"showdown"===this.status?(this.position.y+=5,this.position.y>=3*this.height&&(this.status="showup")):"showup"===this.status&&(this.position.y-=5,this.position.y+this.height<0&&(this.status="down"))},APowerUp.prototype.downAnimation=function(){this.position.y+=10,this.position.y>1136&&dataBus.remove(this)};var Bomb=function(){APowerUp.apply(this,arguments);var t=this;t.image=dataBus.resource.get("bg").entity,t.width=76*dataBus.scale,t.height=136*dataBus.scale,t.sWidth=76,t.sHeight=136,t.sPosition={x:1124,y:1e3}};Bomb.prototype=Object.create(APowerUp.prototype),Bomb.prototype.onFrame=function(){APowerUp.prototype.playAnimation.apply(this,arguments)};var DoubleLaser=function(){APowerUp.apply(this,arguments);var t=this;t.image=dataBus.resource.get("bg").entity,t.width=73*dataBus.scale,t.height=114*dataBus.scale,t.sWidth=73,t.sHeight=114,t.sPosition={x:1050,y:1021}};DoubleLaser.prototype=Object.create(APowerUp.prototype),DoubleLaser.prototype.onFrame=function(){APowerUp.prototype.playAnimation.apply(this,arguments)};var Level1=function(t){this.enemyTypes=[Enemy1],this.count=0,this.width=t.width,this.height=t.height};Level1.prototype.getRandomArbitrary=function(t,e){return Math.random()*(e-t)+t},Level1.prototype.generate=function(t){var e=this;if(40===++e.count){e.count=0;var n=null,o=parseInt(e.getRandomArbitrary(1,5));if(1===o)n=new Enemy1;else if(2===o)n=new Enemy2;else if(3===o)n=new Enemy3;else if(4===o){var i=parseInt(e.getRandomArbitrary(1,5));if(2===i)n=new DoubleLaser;else{if(4!==i)return null;n=new Bomb}}return n.position.x=e.getRandomArbitrary(0,e.width-n.width),n.position.y=-n.height,e.isEgdeCollision(n)?null:n}return null},Level1.prototype.isEgdeCollision=function(t){for(var e,n=0;e=dataBus.list[n];n++)if(e.isEgdeCollision(e,t)&&e instanceof AEnemy)return!0;return!1};var NumberText=function(){AModel.apply(this,arguments);var t=this;t.image=dataBus.resource.get("number").entity,t.number=0,t.width=24,t.height=30,t.sWidth=40,t.sHeight=50,t.addEventListener("frame",function(e){t.sPosition.x=t.sWidth*t.number})};NumberText.prototype=Object.create(AModel.prototype);var Text=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("common").entity,e.width=0,e.height=0,e.sWidth=1,e.sHeight=1,e.sPosition={x:201,y:201}};Text.prototype=Object.create(AModel.prototype),Text.prototype.onAfterFrame=function(t){var e=this,n=t.target.context;n.save(),n.font=e.fontSize+"px Arial",n.fillText(e.text,e.position.x,e.position.y),n.restore()};var BombButton=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=82*dataBus.scale,e.height=68*dataBus.scale,e.sWidth=82,e.sHeight=68,e.sPosition={x:698,y:1066}};BombButton.prototype=Object.create(AModel.prototype);var Cross=function(t){AModel.apply(this,arguments);var e=this;e.image=dataBus.resource.get("bg").entity,e.width=51*dataBus.scale,e.height=54*dataBus.scale,e.sWidth=51,e.sHeight=54,e.sPosition={x:840,y:1076}};Cross.prototype=Object.create(AModel.prototype),KeyboardListener.prototype.setKeyStatus=function(t,e){var n=this.keys;8===t.keyCode?n.Backspace=e:9===t.keyCode?n.Tab=e:12===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?n.Numpad5Center=e:13===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?n.NumpadEnter=e:13===t.keyCode?n.Enter=e:16===t.keyCode?n.ShiftLeft=e:16===t.keyCode?n.ShiftRight=e:17===t.keyCode?n.ControlLeft=e:17===t.keyCode?n.ControlRight=e:18===t.keyCode?n.AltLeft=e:18===t.keyCode?n.AltRight=e:19===t.keyCode?n.Pause=e:20===t.keyCode?n.CapsLock=e:27===t.keyCode?n.Escape=e:32===t.keyCode?n.Space=e:33===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?n.Numpad9PageUp=e:33===t.keyCode?n.PageUp=e:34===t.keyCode?n.PageDown=e:34===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?n.Numpad3PageDown=e:35===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?n.Numpad1End=e:35===t.keyCode?n.End=e:36===t.keyCode?n.Home=e:36===t.keyCode&&t.location===KeyboardEvent.DOM_KEY_LOCATION_NUMPAD?n.Numpad7Home=e:37===t.keyCode?n.ArrowLeft=e:37===t.keyCode?n.Numpad4ArrowLeft=e:38===t.keyCode?n.ArrowUp=e:38===t.keyCode?n.Numpad8ArrowUp=e:39===t.keyCode?n.ArrowRight=e:39===t.keyCode?n.Numpad6ArrowRight=e:40===t.keyCode?n.ArrowDown=e:40===t.keyCode?n.Numpad2ArrowDown=e:45===t.keyCode?n.Insert=e:45===t.keyCode?n.Numpad0Insert=e:46===t.keyCode?n.Delete=e:46===t.keyCode?n.NumpadDecimalDelete=e:48===t.keyCode?n.Digit0=e:49===t.keyCode?n.Digit1=e:50===t.keyCode?n.Digit2=e:51===t.keyCode?n.Digit3=e:52===t.keyCode?n.Digit4=e:53===t.keyCode?n.Digit5=e:54===t.keyCode?n.Digit6=e:55===t.keyCode?n.Digit7=e:56===t.keyCode?n.Digit8=e:57===t.keyCode?n.Digit9=e:65===t.keyCode?n.KeyA=e:66===t.keyCode?n.KeyB=e:67===t.keyCode?n.KeyC=e:68===t.keyCode?n.KeyD=e:69===t.keyCode?n.KeyE=e:70===t.keyCode?n.KeyF=e:71===t.keyCode?n.KeyG=e:72===t.keyCode?n.KeyH=e:73===t.keyCode?n.KeyI=e:74===t.keyCode?n.KeyJ=e:75===t.keyCode?n.KeyK=e:76===t.keyCode?n.KeyL=e:77===t.keyCode?n.KeyM=e:78===t.keyCode?n.KeyN=e:79===t.keyCode?n.KeyO=e:80===t.keyCode?n.KeyP=e:81===t.keyCode?n.KeyQ=e:82===t.keyCode?n.KeyR=e:83===t.keyCode?n.KeyS=e:84===t.keyCode?n.KeyT=e:85===t.keyCode?n.KeyU=e:86===t.keyCode?n.KeyV=e:87===t.keyCode?n.KeyW=e:88===t.keyCode?n.KeyX=e:89===t.keyCode?n.KeyY=e:90===t.keyCode?n.KeyZ=e:91===t.keyCode?n.OSLeft=e:93===t.keyCode?n.ContextMenu=e:96===t.keyCode?n.Numpad0=e:97===t.keyCode?n.Numpad1=e:98===t.keyCode?n.Numpad2=e:99===t.keyCode?n.Numpad3=e:100===t.keyCode?n.Numpad4=e:101===t.keyCode?n.Numpad5=e:102===t.keyCode?n.Numpad6=e:103===t.keyCode?n.Numpad7=e:104===t.keyCode?n.Numpad8=e:105===t.keyCode?n.Numpad9=e:106===t.keyCode?n.NumpadMultiply=e:107===t.keyCode?n.NumpadAdd=e:109===t.keyCode?n.NumpadSubtract=e:110===t.keyCode?n.NumpadDecimal=e:111===t.keyCode?n.NumpadDivide=e:112===t.keyCode?n.F1=e:113===t.keyCode?n.F2=e:114===t.keyCode?n.F3=e:115===t.keyCode?n.F4=e:116===t.keyCode?n.F5=e:117===t.keyCode?n.F6=e:118===t.keyCode?n.F7=e:119===t.keyCode?n.F8=e:120===t.keyCode?n.F9=e:121===t.keyCode?n.F10=e:122===t.keyCode?n.F11=e:123===t.keyCode?n.F12=e:144===t.keyCode?n.NumLock=e:145===t.keyCode?n.ScrollLock=e:186===t.keyCode?n.Semicolon=e:187===t.keyCode?n.Equal=e:188===t.keyCode?n.Comma=e:189===t.keyCode?n.Minus=e:190===t.keyCode?n.Period=e:191===t.keyCode?n.Slash=e:192===t.keyCode?n.Backquote=e:219===t.keyCode?n.BracketLeft=e:220===t.keyCode?n.Backslash=e:221===t.keyCode?n.BracketRight=e:222===t.keyCode&&(n.Quote=e)},MouseListener.prototype.setMouseStatus=function(t,e){var n=this,o=n.mouse;switch(t.which){case 1:o.Left=e,o.Left?(o.LeftDownPosition.X=t.clientX,o.LeftDownPosition.Y=t.clientY):(o.LeftDownPosition.X=0,o.LeftDownPosition.Y=0);break;case 2:o.Middle=e,o.Middle?(o.MiddleDownPosition.X=t.clientX,o.MiddleDownPosition.Y=t.clientY):(o.MiddleDownPosition.X=0,o.MiddleDownPosition.Y=0);break;case 3:o.Right=e,o.Right?(o.RightDownPosition.X=t.clientX,o.RightDownPosition.Y=t.clientY):(o.RightDownPosition.X=0,o.RightDownPosition.Y=0)}};var TouchListener=function(){var t=this;t.list=[],window.addEventListener("touchstart",function(e){e.preventDefault();for(var n,o=0;n=e.changedTouches[o];o++)null===t.find(n.identifier)&&t.list.push({x:n.pageX,y:n.pageY,identifier:n.identifier})}),window.addEventListener("touchmove",function(e){e.preventDefault();for(var n,o=0;n=e.changedTouches[o];o++){var i=t.find(n.identifier);i&&(i.x=n.pageX,i.y=n.pageY)}}),window.addEventListener("touchend",function(e){e.preventDefault();for(var n,o=0;n=e.changedTouches[o];o++){var i=t.find(n.identifier);if(i){var r=t.list.indexOf(i);t.list.splice(r,1)}}}),window.addEventListener("touchcancel",function(e){e.preventDefault();for(var n,o=0;n=e.changedTouches[o];o++){var i=t.find(n.identifier);if(i){var r=list.indexOf(i);t.list.splice(r,1)}}})};TouchListener.prototype.find=function(t){for(var e,n=this,o=0;e=n.list[o];o++)if(e.identifier===t)return e;return null};var Game=function(t){var e=this;e.isPause=!1,e.isDrawBox=!1,e.showFps=!1,e.keyboard=null,e.mouse=null,e.touch=null,e.sound=dataBus.sound,e.resource=dataBus.resource,e.player1=null,e.player2=null,e.resources=null,e.canvas=t.canvas?t.canvas:e.createCanvas(t.width,t.height),e.context=e.canvas.getContext("2d"),e.map=new Level1({width:t.width,height:t.height}),e.width=t.width,e.height=t.height,e.lastTime=Date.now(),e.frameCount=0,e.fps=0,e.score=0,e.scoreList=[],e.bombList=[],e.timer=null,e.fixSound=!1,dataBus.scale=e.width/1136<.5?.5:e.width/1136,t&&(t.keyboard&&(e.keyboard=t.keyboard),t.mouse&&(e.mouse=t.mouse),t.touch&&(e.touch=t.touch)),e.canvas.addEventListener("click",function(t){e.dispatchClick({x:e.mouse.X,y:e.mouse.Y})}),e.canvas.addEventListener("touchend",function(t){var n=e.touch.list[0];n&&e.dispatchClick({x:n.x,y:n.y})}),e.resource.addEventListener("complete",function(t){dataBus.sound.loadList(dataBus.resource.list),e.touchToStart()}),e.resource.loadAll()};Game.prototype.dispatchClick=function(t){for(var e,n=0;e=dataBus.list[n];n++)t.x>=e.position.x&&t.x<=e.position.x+e.width&&t.y>=e.position.y&&t.y<=e.position.y+e.height&&e.dispatchEvent("click",t)},Game.prototype.touchToStart=function(){var t=this,e=new Face;e.width=t.width,e.height=t.width/640*1136;var n=new Button;n.text="开始游戏",n.width=t.width/4,n.height=.25*t.width/4,n.addEventListener("click",function(){t.fixSound||(dataBus.sound.fixIOSCantPlay(),t.fixSound=!0),t.start()}),n.position.x=(t.width-n.width)/2,n.position.y=t.height-n.height-t.height/20,dataBus.add(e),dataBus.add(n),t.draw()},Game.prototype.gameover=function(){var t=this,e=new Dialog;e.position.x=(t.width-e.width)/2,e.position.y=(t.height-e.height)/2;var n=new Button;n.text="重新开始",n.position.x=e.position.x+(e.width-n.width)/2,n.position.y=e.position.y+e.height-n.height-10,n.addEventListener("click",function(e){t.start()});var o=new Text;o.text="飞机大战得分",o.fontSize=15,o.position.x=e.position.x+(e.width-o.text.length*o.fontSize)/2,o.position.y=e.position.y+23;var i=new Text;i.text=t.score.toString(),i.fontSize=20,i.position.x=e.position.x+(e.width-i.text.length*i.fontSize)/2+5,i.position.y=e.position.y+100,dataBus.add(e),dataBus.add(n),dataBus.add(o),dataBus.add(i)},Game.prototype.start=function(){var t=this;try{dataBus.list=[],t.scoreList=[],t.bombList=[],t.score=0,t.bombs=0,t.addBackground(),t.addScore(),t.addPlayer1(),t.addBombButton(),t.sound.play("bgm",!0),t.timer?t.isPause=!1:t.loop()}catch(e){alert(e.message)}},Game.prototype.createCanvas=function(t,e){var n=document.createElement("canvas");return n.width=t,n.height=e,document.body.appendChild(n),n},Game.prototype.loop=function(){var t=this,e=function(n){t.keyboard.Enter&&(t.isPause=!t.isPause),t.isPause||(t.generateEnermy(n),t.keyboardWatch(n),t.touchWatch(n),t.update(n),t.draw(n)),t.isPause&&!t.sound.isPause&&t.sound.pause(),!t.isPause&&t.sound.isPause&&t.sound["continue"](),t.timer=requestAnimationFrame(e)};t.timer=requestAnimationFrame(e)},Game.prototype.generateEnermy=function(t){var e=this,n=e.map.generate(t);n&&(n.addEventListener("explode",function(t){e.score++}),dataBus.add(n))},Game.prototype.draw=function(){for(var t,e=this,n=Date.now(),o=0;t=dataBus.list[o];o++)if(t.onFrame&&t.onFrame({target:e}),"undefined"!=typeof t.getCenter){var i=t.getCenter();e.context.save(),e.context.translate(i.x,i.y),e.context.rotate(t.rotate*Math.PI/180),e.context.translate(-t.width/2,-t.height/2),e.context.drawImage(t.image,t.sPosition.x,t.sPosition.y,t.sWidth,t.sHeight,0,0,t.width,t.height),e.context.restore(),!e.isDrawBox||t instanceof Background||(e.context.save(),e.context.strokeStyle="red",e.context.strokeRect(t.position.x,t.position.y,t.width,t.height),e.context.fillText(t.position.x+","+t.position.y,t.position.x,t.position.y),e.context.restore()),t.onAfterFrame&&t.onAfterFrame({target:e})}e.drawScore(),e.drawBomb(),e.showFps&&(n-e.lastTime>=1e3&&(e.fps=e.frameCount,e.lastTime=n,e.frameCount=0),++e.frameCount,e.context.save(),e.context.strokeStyle="black",e.context.fillText("FPS:"+e.fps,20,e.height-20),e.context.restore())},Game.prototype.drawScore=function(){var t=this,e=t.score,n=0,o=0;if(t.scoreList.length)for(;e>0;)n=e%10,t.scoreList[o].number=n,e=parseInt(e/10),o++},Game.prototype.drawBomb=function(){var t=this;null!==t.player1&&(t.bombList[2].number=t.player1.bombs)},Game.prototype.addBombButton=function(){var t=this,e=new BombButton({position:{x:0}});e.position.y=t.height-e.height;var n=new Cross({position:{x:e.width}});n.position.y=t.height-n.height;var o=new NumberText;o.position.x=e.width+n.width,o.position.y=t.height-o.height,t.bombList.push(e),t.bombList.push(n),t.bombList.push(o),dataBus.add(e),dataBus.add(n),dataBus.add(o)},Game.prototype.update=function(t){for(var e,n=this,o=0;e=dataBus.list[o];o++)e.dispatchEvent("frame",{target:n,timeStamp:t});dataBus.execRemove()},Game.prototype.addBackground=function(){var t=this,e=new Background({windowWidth:t.width,windowHeight:t.height}),n=new Background({windowWidth:t.width,windowHeight:t.height});n.position.y=-n.height,dataBus.add(e),dataBus.add(n)},Game.prototype.addScore=function(){for(var t=this,e=5;e>=0;e--){var n=new NumberText;n.position.x=e*n.width,t.scoreList.push(n),dataBus.add(n)}},Game.prototype.addPlayer1=function(){var t=this,e=new Plane({scale:t.scale});e.position.x=(t.canvas.width-e.width)/2,e.position.y=t.canvas.height-1.2*e.height,e.addEventListener("explode",function(e){t.gameover(),t.isPause=!0,dataBus.sound.pause()}),e.addEventListener("dropBomb",function(t){for(var e,n=0;e=dataBus.list[n];n++)e instanceof AEnemy&&(e.hp=0,e.explodeAnimation())}),t.player1=e,dataBus.add(t.player1)},Game.prototype.keyboardWatch=function(){var t=this,e=t.keyboard;if(t.player1){var n=t.player1;e.KeyW&&n.position.y>0&&(n.position.y-=n.speed),e.KeyA&&n.position.x>0&&(n.position.x-=n.speed),e.KeyS&&n.position.y+n.height<t.height&&(n.position.y+=n.speed),e.KeyD&&n.position.x+n.width<t.width&&(n.position.x+=n.speed),e.KeyJ&&(dataBus.list=dataBus.list.concat(n.fire())),e.KeyK&&n.dropBomb()}},Game.prototype.touchWatch=function(){var t=this,e=t.player1,n=t.findTouchPoint(e);n&&(e.position.x=n.x-e.width/2,e.position.y=n.y-e.height/2,dataBus.list=dataBus.list.concat(e.fire()));var o=t.findTouchPoint(t.bombList[0]);o&&e.dropBomb()},Game.prototype.findTouchPoint=function(t){for(var e,n=this,o=0;e=n.touch.list[o];o++)if(t.inBox(e))return e;return null};